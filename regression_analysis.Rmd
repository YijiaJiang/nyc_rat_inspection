---
title: "Regression"
output: 
  html_document:
    toc: true
    toc_float: 
      toc_collapsed: true
    toc_depth: 5
    code_folding: hide
---

<h1><strong>REGRESSION</strong></h1>

&nbsp;

In this section, we are intended to construct a linear model to generate the monthly number of rats observed using a variety of potential predictors potential predictors, as well as a logistic model to predict the chance of seeing a rat. These two models will be further utilized in the Shiny App for rat activity prediction. 



&nbsp;

&nbsp;

```{r, include=FALSE, message = FALSE, warning = FALSE}
library(tidyverse)
library(readxl)
library(car)
library(ggplot2)
library(GGally)
library(rstatix)
```


```{r, include = FALSE, message = FALSE, warning = FALSE}
# import the rat dataset
url_2012 = "https://raw.githubusercontent.com/YijiaJiang/p8105_final_project_data/main/rat_2012.csv"
rat_2012 = read_csv(url(url_2012)) 
url_2013 = "https://raw.githubusercontent.com/YijiaJiang/p8105_final_project_data/main/rat_2013.csv"
rat_2013 = read_csv(url(url_2013)) 
url_2014 = "https://raw.githubusercontent.com/YijiaJiang/p8105_final_project_data/main/rat_2014.csv"
rat_2014 = read_csv(url(url_2014)) 
url_2015 = "https://raw.githubusercontent.com/YijiaJiang/p8105_final_project_data/main/rat_2015.csv"
rat_2015 = read_csv(url(url_2015)) 
url_2016 = "https://raw.githubusercontent.com/YijiaJiang/p8105_final_project_data/main/rat_2016.csv"
rat_2016 = read_csv(url(url_2016)) 
url_2017 = "https://raw.githubusercontent.com/YijiaJiang/p8105_final_project_data/main/rat_2017.csv"
rat_2017 = read_csv(url(url_2017)) 
url_2018 = "https://raw.githubusercontent.com/YijiaJiang/p8105_final_project_data/main/rat_2018.csv"
rat_2018 = read_csv(url(url_2018)) 
url_2019 = "https://raw.githubusercontent.com/YijiaJiang/p8105_final_project_data/main/rat_2019.csv"
rat_2019 = read_csv(url(url_2019)) 
url_2020 = "https://raw.githubusercontent.com/YijiaJiang/p8105_final_project_data/main/rat_2020.csv"
rat_2020 = read_csv(url(url_2020)) 
url_2021 = "https://raw.githubusercontent.com/YijiaJiang/p8105_final_project_data/main/rat_2021.csv"
rat_2021 = read_csv(url(url_2021)) 
```


```{r, message = FALSE, warning = FALSE}
# tidy the data
rat = bind_rows(rat_2012, rat_2013, rat_2014, rat_2015, rat_2016, rat_2017, rat_2018, rat_2019, rat_2020, rat_2021) %>%
  select(-...1) %>%
  mutate(inspection_month_n = case_when(inspection_month == "Jan" ~ 1,
                                        inspection_month == "Feb" ~ 2,
                                        inspection_month == "Mar" ~ 3,
                                        inspection_month == "Apr" ~ 4,
                                        inspection_month == "May" ~ 5,
                                        inspection_month == "Jun" ~ 6,
                                        inspection_month == "Jul" ~ 7,
                                        inspection_month == "Aug" ~ 8,
                                        inspection_month == "Sep" ~ 9,
                                        inspection_month == "Oct" ~ 10,
                                        inspection_month == "Nov" ~ 11,
                                        inspection_month == "Dec" ~ 12)) %>%
  mutate(date = paste(inspection_year, inspection_month_n, inspection_day, sep = "-")) %>%
  mutate(date = as.Date(date,format = "%Y-%m-%d")) %>% 
  mutate(inspection_ym = paste(inspection_year, inspection_month_n, sep = "-")) %>%
  mutate(covid_yn = case_when(date < "2020-02-29" ~ 0,
                              TRUE ~ 1)) %>%
  mutate(covid_yn = as.factor(covid_yn)) %>%
  separate(inspection_time, into = c("hour", "minute", "second")) %>%
  mutate(hour = as.numeric(hour)) %>%
  mutate(inspection_daytime = case_when(
      hour < 6 | hour >= 18 ~ "Night",
      hour >= 6 & hour < 12 ~ "Morning",
      hour >= 12 & hour < 18 ~ "Afternoon"))
```

## Linear Regression Model

### Exploratory Statistical Analyses

```{r, message=FALSE, warning=FALSE, fig.height=16, fig.width=16}
cases = rat %>% 
  select(inspection_ym, borough, inspection_month_n) %>% 
  group_by(inspection_ym, borough) %>% 
  add_count(borough, inspection_ym, name = "borough_monthly_cases") %>%
  distinct()

rat_tidy = rat %>%
  dplyr::select(boro_code, borough, inspection_ym, inspection_month, covid_yn, prcp, snow, snwd, tmin, tmax) %>%
  mutate(borough = as.factor(borough),
         inspection_month = as.factor(inspection_month)) %>%
  group_by(inspection_ym, borough) %>% 
  summarise(avg_prcp = mean(prcp), 
            avg_snow = mean(snow), 
            avg_snwd = mean(snwd),
            avg_tmin = mean(tmin),
            avg_tmax = mean(tmax)) %>%
  mutate(avg_temp = (avg_tmin + avg_tmax)/2) %>% 
  mutate(covid_yn = case_when(inspection_ym < "2020-02" ~ 0, TRUE ~ 1)) %>% 
  mutate(boro_code = case_when(borough == "Manhattan" ~ 1,
                               borough == "Bronx" ~ 2,
                               borough == "Brooklyn" ~ 1,
                               borough == "Queens" ~ 4,
                               borough == "Staten Island" ~ 5))

cases_borough_monthly = merge(x = rat_tidy, y = cases, by = c("inspection_ym", "borough")) 

# correlation between key predictors
cases_borough_monthly %>%
  dplyr::select(borough, inspection_month_n, avg_prcp, avg_snow, avg_snwd, avg_tmin, avg_tmax, avg_temp, covid_yn) %>% 
  mutate(inspection_month_n = as.factor(inspection_month_n),
         covid_yn = as.factor(covid_yn)) %>% 
  rename(
    "Borough" = borough,
    "Month" = inspection_month_n,
    "Average Precipitation" = avg_prcp,
    "Average Snowfall" = avg_snow,
    "Average Snow Depth" = avg_snwd,
    "Average Tmin" = avg_tmin,
    "Average Tmax" = avg_tmax,
    "Average Temperature" = avg_temp,
    "COVID" = covid_yn
  ) %>% 
  ggpairs(
    title = "Correlations Between Key Outcomes"
  ) + 
  scale_fill_discrete()
```


```{r, message=FALSE, warning=FALSE, fig.height=8, fig.width=8}
# correlation between predictors and outcome
cases_borough_monthly %>% 
  dplyr::select(boro_code, inspection_month_n, avg_prcp, avg_snow, avg_snwd, avg_tmin, avg_tmax, avg_temp, covid_yn, borough_monthly_cases) %>%
  rename(
    "Borough" = boro_code,
    "Month" = inspection_month_n,
    "Average Precipitation" = avg_prcp,
    "Average Snowfall" = avg_snow,
    "Average Snow Depth" = avg_snwd,
    "Average Tmin" = avg_tmin,
    "Average Tmax" = avg_tmax,
    "Average Temperature" = avg_temp,
    "COVID" = covid_yn
  ) %>% 
  cor_mat() %>%
  cor_gather() %>%
  filter(var1 %in% "borough_monthly_cases") %>%
  filter(!var2 %in% "borough_monthly_cases") %>%
  ggplot(aes(x = var1, y = var2, fill = cor, label = cor)) + 
  geom_tile(color = "white") +   
  geom_text(color = "white",size = 4) + 
  scale_x_discrete(labels = c("Borough Monthly cases")) + 
  labs(x = "Outcome Variable", y = "Predictor Variables",
    title = "Correlation Matrix between Predictors and Outcome",
    fill = "Correlation")

# variable overview
skimr::skim(cases_borough_monthly)
```

&nbsp;


### Model Fitting

```{r, message = FALSE, warning = FALSE}
# full model
cases_borough_monthly = cases_borough_monthly %>% 
  mutate(inspection_month = month.abb[inspection_month_n],
         covid_yn = as.factor(covid_yn))


model_linear_full = lm(borough_monthly_cases ~ inspection_month + borough + covid_yn + avg_prcp + avg_snow + avg_snwd + avg_temp, data = cases_borough_monthly) 

broom::tidy(model_linear_full) %>% 
  knitr::kable()

summary(model_linear_full)
```

Full model: borough_monthly_cases ~ inspection_month + borough + covid_yn + avg_prcp + avg_snow + avg_snwd + avg_temp


```{r, message = FALSE, warning = FALSE}
# stepwise with AIC (full model)
step(model_linear_full, direction = "both")

model_linear = lm(borough_monthly_cases ~ borough + covid_yn + avg_snow + avg_snwd, data = cases_borough_monthly) 


broom::tidy(model_linear) %>% 
  knitr::kable()

summary(model_linear)
```


Stepwise model: borough_monthly_cases ~ borough + covid_yn + avg_snow + avg_snwd


```{r, message = FALSE, warning = FALSE}
# full model with log transformation
model_linear_full_log = lm(log(borough_monthly_cases) ~ inspection_month + borough + covid_yn + avg_prcp + avg_snow + avg_snwd + avg_temp, data = cases_borough_monthly) 

broom::tidy(model_linear_full_log) %>% 
  knitr::kable()

summary(model_linear_full_log)
```

Full model with transformation: log(borough_monthly_cases) ~ inspection_month + borough + covid_yn + avg_prcp + avg_snow + avg_snwd + avg_temp


```{r, message = FALSE, warning = FALSE}
# stepwise with AIC
step(model_linear_full_log, direction = "both")

model_linear_log = lm(log(borough_monthly_cases) ~ inspection_month + borough + covid_yn + avg_prcp + avg_snwd + avg_temp, data = cases_borough_monthly) 


broom::tidy(model_linear_log) %>% 
  knitr::kable()

summary(model_linear_log)
```

Stepwise model with log transformation: log(borough_monthly_cases) ~ inspection_month + borough + covid_yn + avg_prcp + avg_snwd + avg_temp


### Model Diagnostics

```{r, message = FALSE, warning = FALSE}
set.seed(100)
par(mfrow = c(2,2))
plot(model_linear)
anova(model_linear)


set.seed(100)
par(mfrow = c(2,2))
plot(model_linear_log)
anova(model_linear_log)
```


```{r, message = FALSE, warning = FALSE}
outlierTest(model_linear)
durbinWatsonTest(model_linear)
performance::check_collinearity(model_linear)

outlierTest(model_linear_log)
durbinWatsonTest(model_linear_log)
performance::check_collinearity(model_linear_log)
```


&nbsp;



### Cross-validation


The final model is log(borough_monthly_cases) ~ inspection_month + borough + covid_yn + avg_prcp + avg_snwd + avg_temp

&nbsp;
&nbsp;
&nbsp;


## Logistic Regression Model


We set the Result variable as the binary outcome. Passed(0) means none was inspected. 

```{r, message = FALSE, warning = FALSE}
rat_binary = rat %>% 
  dplyr::select(result, borough, inspection_month, inspection_daytime, covid_yn, prcp, snow, snwd, tmin, tmax) %>%
  mutate(inspection_result = case_when(
    result == "Passed" ~ 0, 
    result == "Rat Activity" ~ 1)) %>% 
  drop_na(inspection_result) %>%
  mutate(inspection_result = as.factor(inspection_result), 
         borough = as.factor(borough),
         covid_yn = as.factor(covid_yn),
         inspection_month = as.factor(inspection_month), 
         inspection_daytime = as.factor(inspection_daytime)) %>%
  mutate(avg_temp = (tmin + tmax)/2) %>% 
  mutate(feeling = as.character(avg_temp)) %>% 
  mutate(feeling = case_when(
      avg_temp <= 0 ~ 'Frozen',
      avg_temp <= 10 ~ 'Cold',
      avg_temp <= 20 ~ 'Cool',
      avg_temp <= 30 ~ 'Warm',
      avg_temp <= 40 ~ 'Hot')) %>% 
  distinct()
```


### Exploratory Statistical Analyses
```{r, message = FALSE, warning = FALSE}
# correlation between key predictors
rat_binary %>%
  dplyr::select(inspection_month, borough, covid_yn, inspection_daytime, prcp, snow, snwd, feeling) %>% 
  mutate(inspection_month_n = as.factor(inspection_month_n),
         covid_yn = as.factor(covid_yn)) %>% 
  rename(
    "Borough" = borough,
    "Month" = inspection_month_n,
    "Average Precipitation" = avg_prcp,
    "Average Snowfall" = avg_snow,
    "Average Snow Depth" = avg_snwd,
    "Average Tmin" = avg_tmin,
    "Average Tmax" = avg_tmax,
    "Average Temperature" = avg_temp,
    "COVID" = covid_yn
  ) %>% 
  ggpairs(
    title = "Correlations Between Key Outcomes"
  ) + 
  scale_fill_discrete()

# correlation between predictors and outcome
cases_borough_monthly %>% 
  dplyr::select(boro_code, inspection_month_n, avg_prcp, avg_snow, avg_snwd, avg_tmin, avg_tmax, avg_temp, covid_yn, borough_monthly_cases) %>%
  rename(
    "Borough" = boro_code,
    "Month" = inspection_month_n,
    "Average Precipitation" = avg_prcp,
    "Average Snowfall" = avg_snow,
    "Average Snow Depth" = avg_snwd,
    "Average Tmin" = avg_tmin,
    "Average Tmax" = avg_tmax,
    "Average Temperature" = avg_temp,
    "COVID" = covid_yn
  ) %>% 
  cor_mat() %>%
  cor_gather() %>%
  filter(var1 %in% "borough_monthly_cases") %>%
  filter(!var2 %in% "borough_monthly_cases") %>%
  ggplot(aes(x = var1, y = var2, fill = cor, label = cor)) + 
  geom_tile(color = "white") +   
  geom_text(color = "white",size = 4) + 
  scale_x_discrete(labels = c("Borough Monthly cases")) + 
  labs(x = "Outcome Variable", y = "Predictor Variables",
    title = "Correlation Matrix between Predictors and Outcome",
    fill = "Correlation")

# variable overview
skimr::skim(cases_borough_monthly)
```

### Model Fitting

```{r, message = FALSE, warning = FALSE}
model_logit_full = glm(inspection_result ~ inspection_month + borough + covid_yn + inspection_daytime + prcp + snow + snwd + feeling, data = rat_binary, family = "binomial")

step(model_logit_original, direction = "backward")
broom::tidy(model_logit) %>% 
  knitr::kable()

summary(model_logit_original)
anova(model_logit_original)
```

### Model Diagnostics

```{r, message = FALSE, warning = FALSE}
set.seed(100)
par(mfrow = c(2,2))
plot(model_logit)
anova(model_logit)

```
## Merge with Covid-19


```{r, message = FALSE, warning = FALSE}

url_covid = "https://raw.githubusercontent.com/YijiaJiang/p8105_final_project_data/main/rat_weather_covid.csv"
rat_covid = read_csv(url_covid)


rat_covid = rat_covid %>%
  mutate(inspection_month_n = case_when(inspection_month == "Jan" ~ 1,
                                   inspection_month == "Feb" ~ 2,
                                   inspection_month == "Mar" ~ 3,
                                   inspection_month == "Apr" ~ 4,
                                   inspection_month == "May" ~ 5,
                                   inspection_month == "Jun" ~ 6,
                                   inspection_month == "Jul" ~ 7,
                                   inspection_month == "Aug" ~ 8,
                                   inspection_month == "Sep" ~ 9,
                                   inspection_month == "Oct" ~ 10,
                                   inspection_month == "Nov" ~ 11,
                                   inspection_month == "Dec" ~ 12)) %>%
  mutate(date = paste(inspection_year, inspection_month_n, inspection_day, sep = "-"))%>%
  mutate(date = as.Date(date,format = "%Y-%m-%d"))

```
