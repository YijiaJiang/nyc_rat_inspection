---
title: "Report"
output:
  html_document:
    toc: yes
    toc_float:
      toc_collapsed: yes
    toc_depth: 5
    code_folding: hide
---

<h1><strong>REPORT</strong></h1>

&nbsp;


## Motivation

New York City is one of the largest and most popular cities in the United States. It is popular for its hustle and bustle, Wall Street legends and Broadway shows. It looks like the city never sleeps. Whenever you go outside, you will see people walking here and there and doing some sorts of things. However, like humans, rats are present in the city in a large number, with an estimate number of 2 million.

NYC rats, also known as Norway rats, first came to New York City in the 18th century, and as the city’s population grew, so did the rodent population. New York city harbors one of the largest rat populations in the United States. Thus, with time, the issue of rats is quite serious and is even getting worse. 

Surprisingly, NYC is setting a record in 2022 for rat sightings, with 16,000 rodents sightings reported through the end of July. During the pandemic, reported rat sightings, health inspections finding evidence of rat activity and cases of a disease spread via rat urine are all on the rise, which raised our concerns. 

Therefore, by combining the COVID case count and weather information, we are intended to provide an in-depth look at NYC rat inspection database with an exploratory data analysis, as well as statistical analysis including hypothesis test and regression analysis. Gaining deeper sights into the pattern and characteristics of rat inspections in both the temporal and spatial dimensions will help those in fear of rats minimize exposure as much as possible. Broadly, it is beneficial to identify potential risks of disease-spread and then build a clean and pleasant living environment, which is what we as public health students should be working towards.

&nbsp;

&nbsp;



## Related Work

Our project is inspired by the interesting gives the public the facts about rats in New York. 

* <strong>Video</strong>: [Why New York Has So Many Rats](https://www.youtube.com/watch?v=6rNvxML07CU) 
* <strong>Web-based mapping application</strong>: [NYC Rat Information Portal](https://www.nyc.gov/site/doh/health/health-topics/rats.page)


&nbsp;

&nbsp;

## Research Questions

Initial questions: What questions are you trying to answer? How did these questions evolve over the course of the project? What new questions did you consider in the course of your analysis? 

* How do the rat population 
* Are there any 
* Analyze climatic and geographical characteristics, and results of rat inspection

Compare the number of rat inspection cases across years
Explore the trend in the number of rat inspections throughout the years
Evaluate the efficiency in handling rat related complaints among different agencies
Conduct hypothesis test to compare the rat density in different boroughs and time
Construct a linear model that predicts the rate of observing a rat from various potential covariates, including climatic and geographical factors
 
The detailed information concerning our data analysis can be found 


&nbsp;
&nbsp;


## Data

### Data Sources


#### DOHMH Rodent Inspection Data

The [rodent inspection data](https://data.cityofnewyork.us/Health/Rodent-Inspection/p937-wjvj) contains the information on rat sightings and intervention visits in NYC from 1918 to 2022, which is managed by New York City Department of Health and Mental Hygiene, Division of Environmental Health. The data source is the Veterinary, Rodent and Vector Surveillance System (VRVSS). It is also available on the [Rat Information Portal](https://www.nyc.gov/site/doh/health/health-topics/rats.page), which is a web-based mapping application where users can view and map rat inspection and intervention data. Users can search results from Health Department inspections for rats at the level of individual properties, and view neighborhood maps. 

What should to be mentioned is that most of the inspection is due to the complaints from the general public. Thus, if a property/taxlot does not appear in the file, which does not indicate an absence of rats - rather just that it has not been inspected. Similarly, neighborhoods with higher numbers properties with active rat signs may not actually have higher rat populations but simply have more inspections.


&nbsp;


#### NYC Daily Weather Data


The [NYC daily weather data](https://www.ncei.noaa.gov/metadata/geoportal/rest/metadata/item/gov.noaa.ncdc:C00861/html) from the National Oceanic and Atmospheric Association (NOAA) of the National Centers for Environmental Information (NCEI), consists of the NYC daily climate observations from the Central Park station (id: USW00094728), which is integrated by the GHCN (Global Historical Climatology Network)-Daily database. The data is also available to be retrieved using R functions from the `rnoaa` package. 

Global Historical Climate Network includes daily land surface observations from over 100,000 stations in 180 countries and territories. The GHCN-Daily was developed to meet the needs of climate analysis and monitoring studies that require data at a sub-monthly time resolution (e.g., assessments of the frequency of heavy rainfall, heat wave duration, etc.). NCEI provides numerous daily variables, including maximum and minimum temperature, total daily precipitation, snowfall, and snow depth; however, about one half of the stations report precipitation only. Both the record length and period of record vary by station and cover intervals ranging from less than a year to more than 175 years. 


&nbsp;


#### NYC COVID-19 Daily Case Count Data


The [NYC COVID-19 daily case count data](https://data.cityofnewyork.us/Health/COVID-19-Daily-Counts-of-Cases-Hospitalizations-an/rc75-m7u3), provided by New York City Department of Health and Mental Hygiene (DOHMH), represents citywide and borough-specific daily counts of COVID-19 confirmed cases and COVID-related hospitalizations and confirmed and probable deaths among New York City residents. The case counts are aggregated by date of diagnosis (i.e., date of specimen collection), and the hospitalization cases areaggregated by date of admission, and death cases are aggregated by date of death. 

Data collection is since February 29, 2020, which is the date that the Health Department classifies as the start of the COVID-19 outbreak in NYC as it was the date of the first laboratory-confirmed COVID-19 case. Data on confirmed cases were passively reported to the NYC Health Department by hospital, commercial, and public health laboratories. In March, April, and early May, the NYC Health Department had discouraged people with mild and moderate symptoms from being tested, so our data primarily represent people with more severe illness. Until mid-May, patients with more severe COVID-19 illness were more likely to have been tested and included in these data. Data on hospitalizations for confirmed COVID-19 cases were obtained from direct remote access to electronic health record systems, regional health information organization (RHIOs), and NYC Health and Hospital information, as well as matching to syndromic surveillance. Deaths were confirmed by the New York City Office of the Chief Medical Examiner and the Health Department’s Bureau of Vital Statistics. Data counts are underestimates. This dataset has been available to the public since May 19, 2020, and is updated on a daily basis.

These data can be used to:  

* Identify temporal trends in the number of persons diagnosed with COVID-19, citywide and by borough.
* Identify temporal trends in the numbers of COVID-19-related hospitalizations and deaths, citywide and by borough.

&nbsp;


#### NYC Borough Population Data


The [NYC borough population data](http://www.citypopulation.de/en/usa/newyorkcity/), provided by City Population, consists of the population of the boroughs of New York City according to the U.S. Census Bureau results. Additional information about the population structure including gender, age groups, age distribution, race, ethnicity can be also found.


&nbsp;

&nbsp;

### Data Cleaning


Due to the large size of our final project datasets, another [repository](https://github.com/YijiaJiang/p8105_final_project_data) is created for storing tidied data. The codes below describes the steps we took to collate and merge dataset we used in the following exploratory and statistical analysis. Moreover, the detailed data preprocessing procedures can be find [here](https://github.com/YijiaJiang/p8105_final_project_data/blob/main/data_preprocessing_rat.Rmd). 


```{r setup, include = FALSE}
library(tidyverse)
library(RSocrata)
library(rnoaa)
```

```{r, eval = FALSE}
# deal with rat inspection data
url_rat = "https://data.cityofnewyork.us/OData.svc/p937-wjvj"
rat = read.socrata(url_rat) %>% 
  janitor::clean_names()

rat_tidy = rat %>%
  select(inspection_type, bbl, zip_code, street_name, latitude, longitude, borough, result, inspection_date, approved_date) %>%
  drop_na() %>% 
  mutate(boro_code = substr(bbl, 1, 1),
         block = substr(bbl, 2, 6),
         lot = substr(bbl, 7, 10)) %>% 
  select(inspection_type, boro_code, block, lot, zip_code, street_name, latitude, longitude, borough, result, inspection_date, approved_date) %>% 
  separate(inspection_date, c("inspection_date", "inspection_time"), " ") %>% 
  separate(inspection_date, c("inspection_year", "inspection_month", "inspection_day"), "-") %>%
  separate(approved_date, c("approved_date", "approved_time"), " ") %>% 
  separate(approved_date, c("approved_year", "approved_month", "approved_day"), "-") %>%
  mutate(inspection_year = as.integer(inspection_year), 
         inspection_month = as.integer(inspection_month), 
         inspection_day = as.integer(inspection_day)) %>%
  mutate(approved_year = as.integer(approved_year), 
         approved_month = as.integer(approved_month), 
         approved_day = as.integer(approved_day)) %>%
  relocate(inspection_year, .before = "inspection_month") %>% 
  relocate(approved_year, .before = "approved_month") %>%
  arrange(inspection_year, inspection_month) %>% 
  mutate(inspection_month = month.abb[inspection_month],
         approved_month = month.abb[approved_month]) %>% 
  filter(inspection_year >= 2012 & inspection_year <= 2021)


# deal with weather data
nycstationsid = ghcnd_stations() %>% 
  filter(id == "USW00094728") %>% 
  distinct(id)

nyc_weather = meteo_pull_monitors(nycstationsid$id, 
                             date_min = "2012-01-01", 
                             date_max = "2021-12-31",
                             var = c("PRCP", "SNOW", "SNWD", "TMAX", "TMIN"))

nyc_weather_tidy = nyc_weather %>% 
  janitor::clean_names() %>%
  separate(date, into = c("year", "month", "day")) %>% 
  mutate(year = as.numeric(year),
         month = month.abb[as.numeric(month)],
         day = as.numeric(day)) %>%
  mutate(prcp = prcp/10,
         tmax = tmax/10,
         tmin = tmin/10) 


# deal with covid data
url_covid = "https://data.cityofnewyork.us/OData.svc/rc75-m7u3"
covid = read.socrata(url_covid) %>% 
  janitor::clean_names() 

covid_tidy = covid %>%
  rename(date = date_of_interest) %>% 
  select(date, contains("case_count")) %>% 
  select(-contains(c("probable_case_count", "case_count_7day_avg", "all_case_count_7day_avg"))) %>%
  separate(date, into = c("year", "month", "day")) %>% 
  mutate(year = as.numeric(year),
         month = month.abb[as.numeric(month)],
         day = as.numeric(day)) %>%
  pivot_longer(
    cols = bx_case_count:si_case_count,
    names_to = "borough",
    values_to = "borough_case_count"
  ) %>% 
  mutate(borough = gsub("_case_count", "", borough)) %>% 
  mutate(borough = dplyr::recode(borough, "bx" = "Bronx","bk" = "Brooklyn","mn" = "Manhattan","si" = "Staten Island","qn" = "Queens")) %>% 
  relocate(case_count, .after = borough_case_count) %>% 
  rename(total_case_count = case_count) 


# merge the above dataframe with covid info.
rat_weather_covid = rat_tidy %>% 
  filter(inspection_year %in% c(2020,2021)) %>% 
  merge(nyc_weather_tidy, by.x = c("inspection_year","inspection_month","inspection_day"), by.y = c("year","month","day")) %>% 
  select(-id) %>% 
  merge(covid_tidy, by.x = c("inspection_year","inspection_month","inspection_day","borough"), by.y = c("year","month","day","borough"))
```

&nbsp;

After cleaning the datasets mentioned above, our tidied and aggregated data has a total of 1,679,675 rows, one for each rat inspection record, and is the basis of our exploratory and statistical analysis. Altogether 24 variables are selected as meaningful and valuable. The specific variable names and their corresponding explanation are listed below:

* `inspection_year`: year of the inspection
* `inspection_month`: month of the inspection 
* `inspection_day`: day of the inspection
* `boro_code`: code assigned to the NYC borough
* `block`: block number for the inspected taxlot; block numbers repeat in different boroughs
* `lot`: lot number for the inspected taxlot (Notes: lot numbers can repeat in different blocks)
* `zip_code`: postal zipcode of the taxlot that was inspected
* `street_name`:
* `latitude`: latitude in decimal degrees of the inspected taxlot (WGS 1984)
* `longitude`: longitude in decimal degrees of the inspected taxlot (WGS 1984)
* `borough`: name of the NYC borough
* `result`: result of the inspection including Active Rat Signs (ARS) and Problem Conditions
* `inspection_time`: time of the inspection.
* `approved_year`: year of the inspection approved by supervisor at DOHMH
* `approved_month`: month of the inspection approved by supervisor at DOHMH
* `approved_day`: day of the inspection approved by supervisor at DOHMH
* `approved_time`: time of the inspection approved by supervisor at DOHMH
* `prcp`: precipitation (mm)
* `snow`: snowfall (mm)
* `snwd`: snow depth (mm)
* `tmax`: maximum temperature (&deg;C)
* `tmin`: minimum temperature (&deg;C)
* `borough_case_count`: count of patients tested who were confirmed to be COVID-19 cases on date_of_interest in borough_of_interest
* `total_case_count`: total count of patients tested who were confirmed to be COVID-19 cases on date_of_interest in NYC

&nbsp;
&nbsp;


### Exploratory Data Analysis

```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(plotly)
library(highcharter)
library(xts)
library(rgdal)
library(leaflet)
library(leaflet.extras)
library(patchwork)
library(GGally)
library(rstatix)

theme_set(theme_minimal() + theme(legend.position = "bottom"))
```

```{r, message=FALSE, include=FALSE}
url_2012 = "https://raw.githubusercontent.com/YijiaJiang/p8105_final_project_data/main/rat_2012.csv"
rat_2012 = read_csv(url_2012)

url_2013 = "https://raw.githubusercontent.com/YijiaJiang/p8105_final_project_data/main/rat_2013.csv"
rat_2013 = read_csv(url_2013)

url_2014 = "https://raw.githubusercontent.com/YijiaJiang/p8105_final_project_data/main/rat_2014.csv"
rat_2014 = read_csv(url_2014)

url_2015 = "https://raw.githubusercontent.com/YijiaJiang/p8105_final_project_data/main/rat_2015.csv"
rat_2015 = read_csv(url_2015)

url_2016 = "https://raw.githubusercontent.com/YijiaJiang/p8105_final_project_data/main/rat_2016.csv"
rat_2016 = read_csv(url_2016) 

url_2017 = "https://raw.githubusercontent.com/YijiaJiang/p8105_final_project_data/main/rat_2017.csv"
rat_2017 = read_csv(url_2017)

url_2018 = "https://raw.githubusercontent.com/YijiaJiang/p8105_final_project_data/main/rat_2018.csv"
rat_2018 = read_csv(url_2018)

url_2019 = "https://raw.githubusercontent.com/YijiaJiang/p8105_final_project_data/main/rat_2019.csv"
rat_2019 = read_csv(url_2019) 

url_2020 = "https://raw.githubusercontent.com/YijiaJiang/p8105_final_project_data/main/rat_2020.csv"
rat_2020 = read_csv(url_2020)

url_2021 = "https://raw.githubusercontent.com/YijiaJiang/p8105_final_project_data/main/rat_2021.csv"
rat_2021 = read_csv(url_2021)

url_covid = "https://raw.githubusercontent.com/YijiaJiang/p8105_final_project_data/main/rat_weather_covid.csv"
rat_covid = read_csv(url_covid)

rat = bind_rows(rat_2012, rat_2013, rat_2014, rat_2015, rat_2016, rat_2017, rat_2018, rat_2019, rat_2020, rat_2021) %>%
  select(-...1) %>%
   mutate(inspection_month_n = dplyr::recode(inspection_month, 
                                   "Jan" = 1,
                                   "Feb" = 2,
                                   "Mar" = 3,
                                   "Apr" = 4,
                                   "May" = 5,
                                   "Jun" = 6,
                                   "Jul" = 7,
                                   "Aug" = 8,
                                   "Sep" = 9,
                                   "Oct" = 10,
                                   "Nov" = 11,
                                   "Dec" = 12)) %>%
  mutate(date = paste(inspection_year, inspection_month_n, inspection_day, sep = "-"))%>%
  mutate(date = as.Date(date,format = "%Y-%m-%d")) 

rat_act = rat %>%
  filter(!result == "Passed")

rat_covid = rat_covid %>%
  mutate(inspection_month_n = dplyr::recode(inspection_month, 
                                   "Jan" = 1,
                                   "Feb" = 2,
                                   "Mar" = 3,
                                   "Apr" = 4,
                                   "May" = 5,
                                   "Jun" = 6,
                                   "Jul" = 7,
                                   "Aug" = 8,
                                   "Sep" = 9,
                                   "Oct" = 10,
                                   "Nov" = 11,
                                   "Dec" = 12)) %>%
  mutate(date = paste(inspection_year, inspection_month_n, inspection_day, sep = "-"))%>%
  mutate(date = as.Date(date,format = "%Y-%m-%d"))

```

#### Time Visualizations

&nbsp;

In order to obtain in-depth sights of the rat inspections across time, we used four different levels to analyze. 

&nbsp;

##### Overall Rat Inspections Across Time 

First, a time series plot was used to illustrate data points at successive intervals of time. From 2012, the number of rat inspections continually presented a increasing trend and reached its peak in 2018. After 2020, it appeared a sharp decrease as the outbreak of COVID-19.

```{r, message=FALSE, warning=FALSE}
by_date = rat %>% 
  group_by(date) %>% 
  summarise(Total = n())

time_series = xts(by_date$Total , order.by= by_date$date)

hchart(time_series, name = "Rat Inspections") %>% 
  hc_credits(enabled = TRUE, text = "Sources: NYC OpenData", style = list(fontSize = "12px")) %>%
  hc_title(text = "Time Series of NYC Rat Inspections") %>%
  hc_legend(enabled = TRUE)
```

&nbsp;

&nbsp;

##### Rat Inspections by Year

To be more specific, we compared the rat inspections year by year. The number was roughly around 150,000 in 2012-2016. There was a surge of rat inspections in 2017 which had 247,985 cases. After staying at the peak in 2018-2019, the number of inspections rapidly dropped to 71,770 in 2020. Whether this drop was associated with COVID-19 will be analyzed in the following section.

```{r, message=FALSE, warning=FALSE}
rat %>%
  mutate(inspection_year = as.factor(inspection_year)) %>%
  group_by(inspection_year) %>%
  summarise(n_obs = n()) %>%
  plot_ly(x = ~inspection_year, y = ~n_obs, type = "scatter", mode = "lines+markers") %>%
  layout(xaxis = list(title = "Year"), 
         yaxis = list(title = "Count"),
         title = "Number of Rat Inspections by Year") 
```

&nbsp;

&nbsp;

##### Rat Inspections by Month

The average number of rat inspections was 13,997. We plotted the number of inspections every months across years and found that rats were more likely to be inspected in spring compared to winter. This might be due to the nicer weather in spring, suitable for rats to wander outside.

```{r, message=FALSE, warning=FALSE}
rat %>%
  mutate(inspection_month = as.factor(inspection_month)) %>%
  mutate(inspection_month = inspection_month %>% 
                       fct_relevel("Jan", "Feb", "Mar","Apr","May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")) %>%
  group_by(inspection_year, inspection_month) %>%
  summarise(n_obs = n()) %>%
  plot_ly(x = ~inspection_month, y = ~n_obs, type = "box",
          color = ~inspection_month) %>%
  layout(xaxis = list(title = "Month"), 
         yaxis = list(title = "Count"),
         title = "Number of Rat Inspections by Month") %>%
  hide_legend()
```

&nbsp;

&nbsp;

##### Rat Inspections Througout a Day {.tabset}

Most rat inspections happened at daytime regardless of the month, concentrated at 9am-12pm. Contradicted with the common sense that rats prefer nightlife, this finding would be corresponding to inspectors' daily schedule. Additionally, there are a few explanations for observing rat during daylight hours:  

*  The infestation is large  
*  The older/sub-dominant rats cannot compete with dominant rats for food during the safer night time period

###### Inspection
```{r, message=FALSE, warning=FALSE}
rat_2021 %>%
  mutate(inspection_day = as.factor(inspection_day)) %>%
  mutate(inspection_month = as.factor(inspection_month)) %>%
  mutate(inspection_month = inspection_month %>% 
                       fct_relevel("Jan", "Feb", "Mar","Apr","May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")) %>%
  separate(inspection_time, into = c("hour", "minute", "second")) %>%
  rename(Month = inspection_month) %>%
  group_by(Month, inspection_day, hour) %>%
  summarise(n_obs = n()) %>%
  plot_ly(x = ~hour, y = ~n_obs, type = "scatter",
          color = ~inspection_day,
          frame = ~Month) %>%
  layout(xaxis = list(title = "Time", range = list(0,24), dtick = 3, 
                      tickvals = c(0, 3, 6, 9, 12, 15, 18, 21, 24),
                      ticktext = c("12am", "3am", "6am", "9am", "12pm", "3pm", "6pm", "9pm", "12am")),
         yaxis = list(title = "Count"),
         title = "Number of Rat Inspections Throughout a Day in 2021") %>%
  hide_legend()

```

&nbsp;

&nbsp;

###### Observed
```{r, message=FALSE, warning=FALSE}
rat_2021 %>%
  filter(!result == "Passed") %>%
  mutate(inspection_day = as.factor(inspection_day)) %>%
  mutate(inspection_month = as.factor(inspection_month)) %>%
  mutate(inspection_month = inspection_month %>% 
                       fct_relevel("Jan", "Feb", "Mar","Apr","May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")) %>%
  separate(inspection_time, into = c("hour", "minute", "second")) %>%
  rename(Month = inspection_month) %>%
  group_by(Month, inspection_day, hour) %>%
  summarise(n_obs = n()) %>%
  plot_ly(x = ~hour, y = ~n_obs, type = "scatter",
          color = ~inspection_day,
          frame = ~Month) %>%
  layout(xaxis = list(title = "Time", range = list(0,24), dtick = 3, 
                      tickvals = c(0, 3, 6, 9, 12, 15, 18, 21, 24),
                      ticktext = c("12am", "3am", "6am", "9am", "12pm", "3pm", "6pm", "9pm", "12am")),
         yaxis = list(title = "Count"),
         title = "Number of Observed Rats Throughout a Day in 2021") %>%
  hide_legend()

```

&nbsp;

&nbsp;

#### Borough Visualizations

&nbsp;

We explored the demographic characteristics of the rat inspections to find whether there exists some potential spatial patterns or not. 

&nbsp;

##### Overall Rat Inspections by Borough

First, let’s look at the overall rat inspections in each borough across years. Brooklyn, Bronx and Manhattan always ranked top 3 most rat inspections while Queens and Staten Island had quite fewer inspections. 

```{r, message=FALSE, warning=FALSE}
# Overall
rat %>%
 mutate(borough = as.factor(borough)) %>%
  rename(Year = inspection_year) %>%
  group_by(Year, borough) %>%
  summarise(n_obs = n()) %>%
  plot_ly(x = ~borough, y = ~n_obs, color = ~borough, frame = ~Year, type = "bar") %>%
  layout(xaxis = list(title = "Borough"), 
         yaxis = list(title = "Count"),
         title = "Number of Rat Inspections by Borough") %>%
  hide_legend()
```

&nbsp;

&nbsp;

##### Rat Inspections VS. Population

It's not sufficient and solid to only go through the number of rat inspections in each borough without considering their populations and land area. Therefore, we combined these factors in certain borough to evaluate the rat density.  

In 2021, Brooklyn had 38,256 rat inspections, which was the most, followed by Manhattan, Bronx, Queens and Staten Island. 

```{r, message=FALSE, warning=FALSE}
# rat vs. population
p_rat = rat %>%
  filter(inspection_year == 2021) %>%
  mutate(borough = as.factor(borough)) %>%
  group_by(borough) %>%
  summarise(rat_obs = n()) %>%
  ggplot(aes(x = rat_obs, y = borough, fill = borough)) +
  geom_col(show.legend = FALSE) +
  scale_fill_manual(values = c("#38C5A3", "#F09968", "#8DA0CB", "#EE90BA", "#A8D14F")) +
  labs(x = "Count",
       y = "Borough",
      titles = "Number of Rat Inspections in 2021") +
  theme(plot.title = element_text(size = 12)) 

p_pop = rat %>%
  filter(inspection_year == 2021) %>%
  mutate(borough = as.factor(borough)) %>%
  group_by(borough) %>%
  summarise(rat_obs = n()) %>%
  mutate(pop = c(1424948, 2641052, 1576876, 2331143, 493494)) %>%
  ggplot(aes(x = pop, y = borough, fill = borough)) +
  geom_col(show.legend = FALSE) +
  scale_fill_manual(values = c("#38C5A3", "#F09968", "#8DA0CB", "#EE90BA", "#A8D14F")) +
  labs(x = "Count",
       y = "Borough",
       titles = "Number of Populations in 2021") +
  theme(plot.title = element_text(size = 12))

p_area = rat %>%
  filter(inspection_year == 2021) %>%
  mutate(borough = as.factor(borough)) %>%
  group_by(borough) %>%
  summarise(rat_obs = n()) %>%
  mutate(area = c(42.2, 69.4, 22.7, 108.7, 57.5)) %>%
  ggplot(aes(x = area, y = borough, fill = borough)) +
  geom_col(show.legend = FALSE) +
  scale_fill_manual(values = c("#38C5A3", "#F09968", "#8DA0CB", "#EE90BA", "#A8D14F")) +
  labs(x = "Land area (square miles)",
       y = "Borough",
       titles = "Land Area") +
  theme(plot.title = element_text(size = 12))


p_rat / (p_pop + p_area)
```

As for the rat density in terms of population, it turned out that Manhattan ranked the first with 0.020321 inspections per person. Similarly, when it comes to the density regarding land area, Manhattan, with 1411.6 inspections per square mile far higher than other four boroughs, won again. Undoubtfully, Manhattan was the most "rattiest" borough in New York City. Moreover, Queens and Staten Island were still the boroughs with least rat inspections.

```{r}
boro = c(1, 2, 3, 4, 5)
rat_obs = c(26116, 38256, 32044, 6733, 2480)
pop = c(1424948, 2641052, 1576876, 2331143, 493494)
area = c(42.2, 69.4, 22.7, 108.7, 57.5)
df = tibble(boro, rat_obs, pop, area)

df = df %>%
  mutate(density_p = rat_obs /pop,
         density_a = rat_obs /area) 

p_density_p = df %>%
  ggplot(aes(x = boro, y = density_p)) +
  geom_point(color = "#38C5A3") +
  geom_line(color = "#38C5A3") +
  labs(x = "Borough",
       y = "Count per person",
       title = "Rat Density - Population") +
  scale_x_continuous(
                labels = c("Bronx", "Brooklyn", "Manhattan", "Queens", "Staten Island")) +
  theme(axis.text = element_text(size = 7))


p_density_a = df %>%
  ggplot(aes(x = boro, y = density_a)) +
  geom_point(color = "#F09968") +
  geom_line(color = "#F09968") +
  labs(x = "Borough",
       y = "Count per square mile",
       title = "Rat Density - Land Area") +
  scale_x_continuous(
                labels = c("Bronx", "Brooklyn", "Manhattan", "Queens", "Staten Island")) +
  theme(axis.text = element_text(size = 7))
  

p_density_p + p_density_a
```

&nbsp;

&nbsp;

##### Rat Inspections by Month in Each Borough {.tabset}

In order to obtain more demographic information, we analyzed the rat inspections stratified by borough and month. Generally, for all five boroughs, more rats were inspected in late spring and summer in 2021, especially in July and August. Individually, Bronx, Brooklyn and Manhattan were above the borough average level while Queens and Staten Island were significantly below the average, which was consistent with our previous findings.

###### Bronx
```{r, message=FALSE, warning=FALSE}
avg_2021 = rat %>%
  filter(inspection_year == 2021) %>%
  mutate(inspection_month = as.factor(inspection_month)) %>%
  mutate(inspection_month = inspection_month %>% 
                       fct_relevel("Jan", "Feb", "Mar","Apr","May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")) %>%
  group_by(inspection_year, inspection_month) %>%
  summarise(n_avg = n()/5)

rat %>%
  filter(borough == "Bronx") %>%
  filter(inspection_year == 2021) %>%
  mutate(inspection_month = as.factor(inspection_month)) %>%
  mutate(inspection_month = inspection_month %>% 
                       fct_relevel("Jan", "Feb", "Mar","Apr","May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")) %>%
  group_by(inspection_year, inspection_month) %>%
  summarise(n_obs = n()) %>%
  mutate(avg_2021_n = c(822.2, 534.8, 1178.0, 1575.2, 2053.2, 2420.8, 3132.2, 3677.6, 1136.0, 701.4, 1969.0, 1925.4)) %>%
  plot_ly(x = ~inspection_month, y = ~n_obs, type = "bar",
          color = "#8DA0CB", alpha = 0.7,
          name = "Bronx") %>%
  add_trace(x = ~inspection_month, 
            y = ~avg_2021_n, 
            type = "scatter", mode = "lines+markers",
            color = "#F09968",
            name = "Borough Average") %>%
  layout(xaxis = list(title = "Month"), 
         yaxis = list(title = "Count"),
         title = "Number of Rat Inspections in Bronx in 2021") 
```

&nbsp;

&nbsp;

###### Brooklyn
```{r, message=FALSE, warning=FALSE}
rat %>%
  filter(borough == "Brooklyn") %>%
  filter(inspection_year == 2021) %>%
  mutate(inspection_month = as.factor(inspection_month)) %>%
  mutate(inspection_month = inspection_month %>% 
                       fct_relevel("Jan", "Feb", "Mar","Apr","May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")) %>%
  group_by(inspection_year, inspection_month) %>%
  summarise(n_obs = n()) %>%
  mutate(avg_2021_n = c(822.2, 534.8, 1178.0, 1575.2, 2053.2, 2420.8, 3132.2, 3677.6, 1136.0, 701.4, 1969.0, 1925.4)) %>%
  plot_ly(x = ~inspection_month, y = ~n_obs, type = "bar",
          color = "#8DA0CB", alpha = 0.7,
          name = "Brooklyn") %>%
  add_trace(x = ~inspection_month, 
            y = ~avg_2021_n, 
            type = "scatter", mode = "lines+markers",
            color = "#F09968",
            name = "Borough Average") %>%
  layout(xaxis = list(title = "Month"), 
         yaxis = list(title = "Count"),
         title = "Number of Rat Inspections in Brooklyn in 2021") 
```

&nbsp;

&nbsp;

###### Manhattan
```{r, message=FALSE, warning=FALSE}
rat %>%
  filter(borough == "Manhattan") %>%
  filter(inspection_year == 2021) %>%
  mutate(inspection_month = as.factor(inspection_month)) %>%
  mutate(inspection_month = inspection_month %>% 
                       fct_relevel("Jan", "Feb", "Mar","Apr","May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")) %>%
  group_by(inspection_year, inspection_month) %>%
  summarise(n_obs = n()) %>%
  mutate(avg_2021_n = c(822.2, 534.8, 1178.0, 1575.2, 2053.2, 2420.8, 3132.2, 3677.6, 1136.0, 701.4, 1969.0, 1925.4)) %>%
  plot_ly(x = ~inspection_month, y = ~n_obs, type = "bar",
          color = "#8DA0CB", alpha = 0.7,
          name = "Manhattan") %>%
  add_trace(x = ~inspection_month, 
            y = ~avg_2021_n, 
            type = "scatter", mode = "lines+markers",
            color = "#F09968",
            name = "Borough Average") %>%
  layout(xaxis = list(title = "Month"), 
         yaxis = list(title = "Count"),
         title = "Number of Rat Inspections in Manhattan in 2021") 
```

&nbsp;

&nbsp;

###### Queens
```{r, message=FALSE, warning=FALSE}
rat %>%
  filter(borough == "Queens") %>%
  filter(inspection_year == 2021) %>%
  mutate(inspection_month = as.factor(inspection_month)) %>%
  mutate(inspection_month = inspection_month %>% 
                       fct_relevel("Jan", "Feb", "Mar","Apr","May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")) %>%
  group_by(inspection_year, inspection_month) %>%
  summarise(n_obs = n()) %>%
  mutate(avg_2021_n = c(822.2, 534.8, 1178.0, 1575.2, 2053.2, 2420.8, 3132.2, 3677.6, 1136.0, 701.4, 1969.0, 1925.4)) %>%
  plot_ly(x = ~inspection_month, y = ~n_obs, type = "bar",
          color = "#8DA0CB", alpha = 0.7,
          name = "Queens") %>%
  add_trace(x = ~inspection_month, 
            y = ~avg_2021_n, 
            type = "scatter", mode = "lines+markers",
            color = "#F09968",
            name = "Borough Average") %>%
  layout(xaxis = list(title = "Month"), 
         yaxis = list(title = "Count"),
         title = "Number of Rat Inspections in Queens in 2021") 
```

&nbsp;

&nbsp;

###### Staten Island
```{r, message=FALSE, warning=FALSE}
rat %>%
  filter(borough == "Staten Island") %>%
  filter(inspection_year == 2021) %>%
  mutate(inspection_month = as.factor(inspection_month)) %>%
  mutate(inspection_month = inspection_month %>% 
                       fct_relevel("Jan", "Feb", "Mar","Apr","May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")) %>%
  group_by(inspection_year, inspection_month) %>%
  summarise(n_obs = n()) %>%
  mutate(avg_2021_n = c(822.2, 534.8, 1178.0, 1575.2, 2053.2, 2420.8, 3132.2, 3677.6, 1136.0, 701.4, 1969.0, 1925.4)) %>%
  plot_ly(x = ~inspection_month, y = ~n_obs, type = "bar",
          color = "#8DA0CB", alpha = 0.7,
          name = "Staten Island") %>%
  add_trace(x = ~inspection_month, 
            y = ~avg_2021_n, 
            type = "scatter", mode = "lines+markers",
            color = "#F09968",
            name = "Borough Average") %>%
  layout(xaxis = list(title = "Month"), 
         yaxis = list(title = "Count"),
         title = "Number of Rat Inspections in Staten Island in 2021") 
```

&nbsp;

&nbsp;

##### Overall Top 15 Rat Popular Streets

To be more detailed, we investigated the fifteen streets with most rat inspections in New York City. Among them, Greene Avenue, Brooklyn with 1366 cases, Broadway, Manhattan with 1154 cases and Hart Street, Brooklyn with 1118 cases ranked the top 3.  

```{r, message=FALSE, warning=FALSE}
# Overall top 15 streets
rat %>%
  filter(inspection_year == 2021) %>%
  mutate(street_name = str_to_title(street_name)) %>%
  group_by(street_name) %>%
  summarise(rat_obs = n()) %>%
  arrange(-rat_obs) %>% 
  top_n(20) %>%
  mutate(street_name = fct_reorder(street_name, rat_obs)) %>%
  plot_ly(x = ~rat_obs, y = ~street_name, color = ~street_name, type = "bar") %>%
  layout(xaxis = list(title = "Count"), 
         yaxis = list(title = "Street"),
         title = "Top 15 Rat Popular Streets in 2021") %>%
  hide_legend()
```

&nbsp;

&nbsp;

##### Top 5 Rat Popular Streets {.tabset}

Below are the five streets with most rat inspections in each borough, respectively.

###### Bronx
```{r, message=FALSE, warning=FALSE}
rat %>%
  filter(inspection_year == 2021) %>%
  filter(borough == "Bronx") %>%
  mutate(street_name = str_to_title(street_name)) %>%
  group_by(street_name) %>%
  summarise(rat_obs = n()) %>%
  arrange(-rat_obs) %>% 
  top_n(5) %>%
  mutate(street_name = fct_reorder(street_name, rat_obs)) %>%
  plot_ly(x = ~rat_obs, y = ~street_name, color = ~street_name, type = "bar") %>%
  layout(xaxis = list(title = "Count"), 
         yaxis = list(title = "Street"),
         title = "Top 5 Rat Popular Streets in Bronx in 2021") %>%
  hide_legend()
```

&nbsp;

&nbsp;

###### Brooklyn
```{r, message=FALSE, warning=FALSE}
rat %>%
  filter(inspection_year == 2021) %>%
  filter(borough == "Brooklyn") %>%
  mutate(street_name = str_to_title(street_name)) %>%
  group_by(street_name) %>%
  summarise(rat_obs = n()) %>%
  arrange(-rat_obs) %>% 
  top_n(5) %>%
  mutate(street_name = fct_reorder(street_name, rat_obs)) %>%
  plot_ly(x = ~rat_obs, y = ~street_name, color = ~street_name, type = "bar") %>%
  layout(xaxis = list(title = "Count"), 
         yaxis = list(title = "Street"),
         title = "Top 5 Rat Popular Streets in Brooklyn in 2021") %>%
  hide_legend()
```

&nbsp;

&nbsp;

###### Manhattan
```{r, message=FALSE, warning=FALSE}
rat %>%
  filter(inspection_year == 2021) %>%
  filter(borough == "Manhattan") %>%
  mutate(street_name = str_to_title(street_name)) %>%
  group_by(street_name) %>%
  summarise(rat_obs = n()) %>%
  arrange(-rat_obs) %>% 
  top_n(5) %>%
  mutate(street_name = fct_reorder(street_name, rat_obs)) %>%
  plot_ly(x = ~rat_obs, y = ~street_name, color = ~street_name, type = "bar") %>%
  layout(xaxis = list(title = "Count"), 
         yaxis = list(title = "Street"),
         title = "Top 5 Rat Popular Streets in Manhattan in 2021") %>%
  hide_legend()
```

&nbsp;

&nbsp;

###### Queens
```{r, message=FALSE, warning=FALSE}
rat %>%
  filter(inspection_year == 2021) %>%
  filter(borough == "Queens") %>%
  mutate(street_name = str_to_title(street_name)) %>%
  group_by(street_name) %>%
  summarise(rat_obs = n()) %>%
  arrange(-rat_obs) %>% 
  top_n(5) %>%
  mutate(street_name = fct_reorder(street_name, rat_obs)) %>%
  plot_ly(x = ~rat_obs, y = ~street_name, color = ~street_name, type = "bar") %>%
  layout(xaxis = list(title = "Count"), 
         yaxis = list(title = "Street"),
         title = "Top 5 Rat Popular Streets in Queens in 2021") %>%
  hide_legend()
```

&nbsp;

&nbsp;

###### Staten Island
```{r, message=FALSE, warning=FALSE}
rat %>%
  filter(inspection_year == 2021) %>%
  filter(borough == "Staten Island") %>%
  mutate(street_name = str_to_title(street_name)) %>%
  group_by(street_name) %>%
  summarise(rat_obs = n()) %>%
  arrange(-rat_obs) %>% 
  top_n(5) %>%
  mutate(street_name = fct_reorder(street_name, rat_obs)) %>%
  plot_ly(x = ~rat_obs, y = ~street_name, color = ~street_name, type = "bar") %>%
  layout(xaxis = list(title = "Count"), 
         yaxis = list(title = "Street"),
         title = "Top 5 Rat Popular Streets in Staten Island in 2021") %>%
  hide_legend()
```

&nbsp;

&nbsp;

#### Inspection Types and Results

&nbsp;

Inspection type and result were two important attributes, which reflect the motivation, method and result of rat inspections. In addition, some other problem conditions such as garbage (poor containerization of food waste resulting in the feeding of rats), harborage (clutter and dense vegetation promoting the nesting of rats), could be identified during this process.

&nbsp;

##### Inspection Types

We can easily observed that initial inspection was the most frequent inspection, accounted for 70.3%. It represents inspection conducted in response to a 311 complaint, or a proactive inspection conducted through our neighborhood indexing program. Baiting and compliance (follow-up) inspection followed. It's very rare to see clean-up and stoppage in the inspection process.

```{r, message=FALSE, warning=FALSE}
# inspection type
colors = c("#38C5A3", "#F09968", "#D2959B", "#B499CB", "#EE90BA", "#A8D14F", "#E5D800", "#FCCD4C", "#E2BF96", "#B3B3B3")

rat %>%
  mutate(inspection_type = case_when(inspection_type == "Initial" ~ "Initial Inspection",
                                     inspection_type == "BAIT" ~ "Baiting", 
                                     inspection_type == "Compliance"~ "Compliance Inspection", 
                                     inspection_type == "STOPPAGE" ~ "Stoppage", 
                                     inspection_type == "CLEAN_UPS" ~ "Clean Up")) %>%
  group_by(inspection_type) %>%
  summarise(n_obs = n(),
            prop = n_obs/nrow(rat)) %>%
  arrange(-prop) %>% 
  mutate(inspection_type = fct_reorder(inspection_type, -prop)) %>%
  plot_ly(labels = ~inspection_type, values = ~prop, type = "pie",
          insidetextfont = list(color = "#FFFFFF"),
          marker = list(colors = colors,
                      line = list(color = '#FFFFFF', width = 1))
          ) %>%
  layout(title = "Distribution of Inspection Type",
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))


```

&nbsp;

&nbsp;

##### Inspection Results

The result of passed had the largest proportion, accounting for 61.6%. Even though in such circumstances, inspector recieved the rat complains but did not observe active signs of rat and mouse activity, or conditions conducive to rodent activity, on the property, we cannot say there was no rats due to their high speed of scurry and wide range of activity. Particularly, 13.6% of results were rat activity. We would like to mention here that active rat signs include any of six different signs below:  

* fresh tracks
* fresh droppings
* active burrows
* active runways and rub marks
* fresh gnawing marks
* live rats

```{r, message=FALSE, warning=FALSE}
# inspection results
colors = c("#38C5A3", "#F09968", "#D2959B", "#B499CB", "#EE90BA", "#A8D14F", "#E5D800", "#FCCD4C", "#E2BF96", "#B3B3B3")

rat %>%
  drop_na() %>%
  group_by(result) %>%
  summarise(n_obs = n(),
            prop = n_obs/nrow(rat)) %>%
  arrange(-prop) %>% 
  mutate(result = fct_reorder(result, -prop)) %>%
  plot_ly(labels = ~result, values = ~prop, type = "pie",
          insidetextfont = list(color = "#FFFFFF"),
          marker = list(colors = colors,
                      line = list(color = '#FFFFFF', width = 1))
          ) %>%
  layout(title = "Distribution of Inspection Results",
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))
```

&nbsp;

&nbsp;

#### Weather and COVID-19

&nbsp;

From previous analysis, we found that weather and COVID-19 were two potential covariates that might affect the rat inspections. As is known to all, rats don't prefer the cold weather but gravitate to temperatures between 30 and 32 degrees Celsius.  
In March 2020, countries around the world including the U.S. deployed various measures of lockdown that lasted on for over a year. This response to the pandemic dominated people's daily lives: they rarely went outside and basically worked from home. As a result, rats lost their "sweet home" and the number of inspections might become smaller.

&nbsp;

##### Weather {.tabset}

Based on the whole range of temperatures in 2021, we found that more rat inspections happened when temperatures were between 20 and 30 degrees Celsius, indicating that rats preferred a warm environment. However, the pattern was not that obvious and the temperatures were almost above 0 degree Celsius in 2021. We could not immediately determine whether rats seldom wandered outside when the temperatures were extremely low. 

###### Inspection
```{r, message=FALSE, warning=FALSE}
# association with temperature
rat_n = rat %>%
  filter(inspection_year == 2021) %>%
  group_by(inspection_year, inspection_month, inspection_day) %>%
  summarise(Count = n())

t = rat %>%
  filter(inspection_year == 2021) %>%
  mutate(`Average Temperature` = (tmin+tmax)/2) %>%
  rename(Date = date) %>%
  distinct(inspection_year, inspection_month, inspection_day, `Average Temperature`, tmax, tmin, Date)

rat_t = left_join(rat_n, t, by = c("inspection_year", "inspection_month", "inspection_day")) %>%
  as.data.frame()

p_weather = rat_t %>% 
  ggplot(aes(x = Date, y = `Average Temperature`)) + 
  geom_point(aes(size = Count), alpha = .5, color = "#66C2A5") +
  geom_smooth(se = FALSE, color = "#8DA0CB") +
  labs(x = "Month",
       y = "Average Temperature",
       title = "Assocition Between Number of Rat Inspections and Temperature in 2021")

ggplotly(p_weather)

```

&nbsp;

&nbsp;

###### Observed
```{r, message=FALSE, warning=FALSE}
# association with temperature
rat_n_o = rat %>%
  filter(!result == "Passed") %>%
  filter(inspection_year == 2021) %>%
  group_by(inspection_year, inspection_month, inspection_day) %>%
  summarise(Count = n())

t = rat %>%
  filter(inspection_year == 2021) %>%
  mutate(`Average Temperature` = (tmin+tmax)/2) %>%
  rename(Date = date) %>%
  distinct(inspection_year, inspection_month, inspection_day, `Average Temperature`, tmax, tmin, Date)

rat_t_o = left_join(rat_n_o, t, by = c("inspection_year", "inspection_month", "inspection_day")) %>%
  as.data.frame()

p_weather_o = rat_t_o %>% 
  ggplot(aes(x = Date, y = `Average Temperature`)) + 
  geom_point(aes(size = Count), alpha = .5, color = "#66C2A5") +
  geom_smooth(se = FALSE, color = "#8DA0CB") +
  labs(x = "Month",
       y = "Average Temperature",
       title = "Assocition Between Number of Observed Rats and Temperature in 2021")

ggplotly(p_weather_o)

```

&nbsp;

&nbsp;

##### COVID-19

Line charts were utilized to compare the rat inspections before and after COVID-19. It's very obvious that after the outbreak of COVID-19, the number of sightings significantly dropped, approximately from 20,000 to 5,000 per month. In April 2021, only 4 cases of rat inspections were recorded.

```{r, message=FALSE, warning=FALSE}
# changes before and after Covid-19
rat %>%
  filter(inspection_year %in% c(2019, 2020)) %>%
  mutate(inspection_year = as.factor(inspection_year)) %>%
  mutate(inspection_month = as.factor(inspection_month)) %>%
  mutate(inspection_month = inspection_month %>% 
                       fct_relevel("Jan", "Feb", "Mar","Apr","May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")) %>%
  group_by(inspection_year, inspection_month) %>%
  summarise(n_obs = n()) %>%
  plot_ly(x = ~inspection_month, y = ~n_obs, type = "scatter", mode = "lines",
          color = ~inspection_year) %>%
  layout(xaxis = list(title = "Inspection Month"), 
         yaxis = list(title = "Number of Inspections"),
         title = "Comparison of Rat Inspections Before and After COVID-19") 
```

We also explored the association between the number of rat inspections and COVID-ID cases. This plot removed the outliers of extremely high daily confirmed cases to focus on the trend. Generally speaking, as the surge of COVID-19 confirmed cases, the number of rat inspections presented a decreasing trend. This finding verified our thought that lockdown policy and self-quarantine reduced the inspection chances and made rats lose their survival environment.

```{r, message=FALSE, warning=FALSE}
# association with Covid-19
rat_obs = rat %>%
  group_by(date) %>%
  summarise(Count = n()) 

c = rat_covid %>%
  distinct(inspection_year, inspection_month, inspection_day, total_case_count, date)

rat_covid_c = left_join(c, rat_obs, by = "date") %>%
  select(inspection_year, date, Count, total_case_count) %>%
  as.data.frame()

p_covid = rat_covid_c %>% 
  filter(total_case_count<=2000) %>%
  rename(Date = date, 
         `COVID-19 Cases` = total_case_count,
         `Rat Inspections` = Count) %>%
  ggplot(aes(x = Date)) + 
  geom_smooth(aes(y = `COVID-19 Cases`, color = "COVID-19"), se = FALSE) +
  geom_smooth(aes(y = `Rat Inspections`, color = "Rat"), se = FALSE) +
  labs(x = "Month",
       y = "Number of Cases",
       title = "Assocition Between Number of Rat Inspections and COVID-19",
       color = "Type") +
  scale_color_manual(values = c("Rat" = "#8DA0CB", "COVID-19" = "#66C2A5"))

ggplotly(p_covid)

```

&nbsp;

&nbsp;



## Statistical Analysis

### Hypothesis Test 

#### Homogenity among Boroughs

&nbsp;

In the section of borough visualizations, we find some indepence among different boroughs in New York. To verify this, we plan to usw chi-square test to see homogenity among boroughs in recent years and homogenity among boroughs in 2021.

&nbsp;


##### Chi-square testing homogenity among boroughs in recent years

We decide to look at the number of inspections over years to figure out the distribution of inspections varies in different boroughs from year to year.

$H_0$ : The distribution of inspections among boroughs are same over years.

$H_1$ : The distribution of inspections among boroughs aren’t all the same over years.

```{r, message = FALSE, warning = FALSE}
# create a data frame
rat_years = rat %>% 
  janitor::clean_names() %>% 
  dplyr::select(inspection_year, borough) %>% 
  group_by(borough, inspection_year) %>%
  summarize(frequency = n()) %>%
  mutate(borough = as.factor(borough),
    borough = fct_reorder(borough, frequency, .desc = TRUE)) %>% 
  pivot_wider(names_from = "inspection_year", values_from = "frequency")

# print the table
rat_years %>% t() %>% 
knitr::kable(caption = "Distribution of inspections across the years")

# Chi-square test
chisq.test(rat_years[,-1]) %>% 
   broom::tidy()
```

We can see from the Chi-square test above, we reject the null hypothesis at 1% significant level. This means that the inspections among boroughs have a different distribution across years.

&nbsp;

&nbsp;

##### Chi-square testing homogenity among boroughs in 2021

Given that the distribution of inspections varies in different boroughs from year to year, we decide to look at inspections among different boroughs in 2021. 

$H_0$ : The distribution of inspections among boroughs are same in 2021.

$H_1$ : The distribution of inspections among boroughs aren’t all the same in 2021.

```{r, message = FALSE, warning = FALSE}
# import the data
rat_boro = rat_2021 %>% 
  janitor::clean_names() %>% 
  dplyr::select(inspection_year, borough) %>% 
  group_by(borough, inspection_year) %>% 
  summarize(frequency = n()) %>%
  mutate(borough = as.factor(borough),
    borough = fct_reorder(borough, frequency, .desc = TRUE)) %>% 
  dplyr::select(borough, frequency)

# print the table
knitr::kable(rat_boro, caption = "Distribution of inspections in 2021")

# chi-square test
chisq.test(rat_boro[,-1]) %>% 
  broom::tidy()
```

We can see from the chi-square test result we should reject the null hypothesis, the inspections are not equally distributed among boroughs in 2021.

&nbsp;

&nbsp;

#### Association with Weather and COVID-19

&nbsp;

In the visualization, we see some difference of rat inspections as the temperature and weather change, as well as the happening of covid-19. 

&nbsp;

##### Chi-sqaure testing association betwwen inspection density and temperature in 2021

$H_0$ : The distribution of inspections in different weather are same in 2021.

$H_1$ : The distribution of inspections in different weather aren’t all the same in 2021.

```{r, message = FALSE, warning = FALSE}
# create a data frame
rat_n = rat_2021 %>%
  group_by(inspection_year, inspection_month, inspection_day)

rat_t = rat %>%
  mutate(Average_Temperature = (tmin + tmax)/2) %>% 
  rename(Date = date) %>%
  mutate(Feeling = as.character(Average_Temperature)) %>% 
  mutate(Feeling = case_when(
      Average_Temperature <= 0 ~ 'Frozen',
      Average_Temperature <= 10 ~ 'Cold',
      Average_Temperature <= 20 ~ 'Cool',
      Average_Temperature <= 30 ~ 'Warm',
      Average_Temperature <= 40 ~ 'Hot')) %>% 
  distinct(inspection_year, inspection_month, inspection_day, Date, Average_Temperature, tmax, tmin, Feeling)

rat_temp = 
  left_join(rat_n, rat_t, by = c("inspection_year", "inspection_month", "inspection_day")) %>%
  dplyr::select(Average_Temperature, Feeling) %>% 
  group_by(Feeling) %>%
  summarize(frequency = n()) %>%
  mutate(Feeling = as.factor(Feeling),
    Feeling = fct_reorder(Feeling, frequency, .desc = TRUE)) %>% 
  pivot_wider(names_from = "Feeling", values_from = "frequency") 

# print the table
knitr::kable(rat_temp, caption = "The association between number of rat inspections and temperature in 2021")

# chi-square test
chisq.test(rat_temp[,-1]) %>% 
  broom::tidy()
```

We can see from the chi-square test result we should reject the null hypothesis, the inspections are not equally distributed in different weather in 2021.

&nbsp;

&nbsp;

##### Wilcoxon Rank-sum testing changes of inspection density caused by COVID-19

For the rodent inspection across time, we compared mean difference between inspection density in 2019 before covid and inspection density in 2020 after covid.

$H_0$ : The distribution of annual inspection before covid and after covid is same.

$H_1$ : The distribution of annual inspection before covid and after covid is different.

```{r, message = FALSE, warning = FALSE}
# import the data
rat_covid = rbind(rat_2019, rat_2020) %>% 
  janitor::clean_names() %>% 
  dplyr::select(inspection_year, inspection_month) %>% 
  mutate(Inspection_year = as.factor(inspection_year),
         Inspection_month = as.factor(inspection_month)) %>%
  mutate(Inspection_month = inspection_month %>% 
                       fct_relevel("Jan", "Feb", "Mar","Apr","May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")) %>%
  group_by(Inspection_year,Inspection_month) %>%
  summarize(Frequency = n())

# print the table
rat_covid2 = rat_covid %>%   
  pivot_wider(names_from = "Inspection_year", values_from = "Frequency")
knitr::kable(rat_covid2, caption = "Number of rat inspections before and after covid")

# Wilcoxon Rank-sum test
wilcox.test(Frequency ~ Inspection_year, data = rat_covid,
                   exact = FALSE)
```

We can see from the Wilcoxon Rank-sum test result that the true location shift is not equal to 0, which means that the medians of two populations differ. Therefore, we have the evidence to reject the null hypothesis and conclude that there is a difference between inspection density in 2019 before covid and inspection density in 2020 after covid.

&nbsp;

&nbsp;

### Regression Analysis

```{r, include=FALSE, message = FALSE, warning = FALSE}
library(tidyverse)
library(readxl)
library(car)
library(ggplot2)
library(GGally)
library(rstatix)
library(modelr)
library(patchwork)
library(see)

theme_set(theme_minimal() + theme(legend.position = "bottom"))
```


#### Exploratory Statistical Analyses

Before constructing the model, we performed the correlational analysis to identify relevant variables and their impacts. 

```{r, include = FALSE, message=FALSE, warning=FALSE}
rat_reg = rat %>%
  mutate(inspection_ym = paste(inspection_year, inspection_month_n, sep = "-")) %>%
  mutate(covid_yn = case_when(date < "2020-02-29" ~ 0,
                              TRUE ~ 1)) %>%
  mutate(covid_yn = as.factor(covid_yn)) %>%
  separate(inspection_time, into = c("hour", "minute", "second")) %>%
  mutate(hour = as.numeric(hour)) %>%
  mutate(inspection_daytime = case_when(
      hour < 6 | hour >= 18 ~ "Night",
      hour >= 6 & hour < 12 ~ "Morning",
      hour >= 12 & hour < 18 ~ "Afternoon"))

cases = rat_reg %>% 
  select(inspection_ym, borough, inspection_month_n) %>% 
  group_by(inspection_ym, borough) %>% 
  add_count(borough, inspection_ym, name = "borough_monthly_cases") %>%
  distinct()

rat_tidy = rat_reg %>%
  dplyr::select(boro_code, borough, inspection_ym, inspection_month, covid_yn, prcp, snow, snwd, tmin, tmax) %>%
  mutate(borough = as.factor(borough),
         inspection_month = as.factor(inspection_month)) %>%
  group_by(inspection_ym, borough) %>% 
  summarise(avg_prcp = mean(prcp), 
            avg_snow = mean(snow), 
            avg_snwd = mean(snwd),
            avg_tmin = mean(tmin),
            avg_tmax = mean(tmax)) %>%
  mutate(avg_temp = (avg_tmin + avg_tmax)/2) %>% 
  mutate(covid_yn = case_when(inspection_ym < "2020-02" ~ 0, TRUE ~ 1)) %>% 
  mutate(boro_code = case_when(borough == "Manhattan" ~ 1,
                               borough == "Bronx" ~ 2,
                               borough == "Brooklyn" ~ 1,
                               borough == "Queens" ~ 4,
                               borough == "Staten Island" ~ 5))

cases_borough_monthly = merge(x = rat_tidy, y = cases, by = c("inspection_ym", "borough")) 
```



```{r, message=FALSE, warning=FALSE, fig.height=16, fig.width=16}
# correlation between key predictors
cases_borough_monthly %>%
  dplyr::select(borough, inspection_month_n, avg_prcp, avg_snow, avg_snwd, avg_tmin, avg_tmax, avg_temp, covid_yn) %>% 
  mutate(inspection_month_n = as.factor(inspection_month_n),
         covid_yn = as.factor(covid_yn)) %>% 
  rename(
    "Borough" = borough,
    "Month" = inspection_month_n,
    "Average Precipitation" = avg_prcp,
    "Average Snowfall" = avg_snow,
    "Average Snow Depth" = avg_snwd,
    "Average Tmin" = avg_tmin,
    "Average Tmax" = avg_tmax,
    "Average Temperature" = avg_temp,
    "COVID" = covid_yn
  ) %>% 
  ggpairs() + 
  scale_fill_discrete()
```

Through the correlation analysis between key predictors, the result above shown that the daily average temperature, the highest temperature, and the lowest temperature are highly correlated between each other.

&nbsp;

```{r, message=FALSE, warning=FALSE, fig.height=6, fig.width=6}
# correlation between predictors and outcome
cases_borough_monthly %>% 
  dplyr::select(boro_code, inspection_month_n, avg_prcp, avg_snow, avg_snwd, avg_tmin, avg_tmax, avg_temp, covid_yn, borough_monthly_cases) %>%
  rename(
    "Borough" = boro_code,
    "Month" = inspection_month_n,
    "Average Precipitation" = avg_prcp,
    "Average Snowfall" = avg_snow,
    "Average Snow Depth" = avg_snwd,
    "Average Tmin" = avg_tmin,
    "Average Tmax" = avg_tmax,
    "Average Temperature" = avg_temp,
    "COVID" = covid_yn
  ) %>% 
  cor_mat() %>%
  cor_gather() %>%
  filter(var1 %in% "borough_monthly_cases") %>%
  filter(!var2 %in% "borough_monthly_cases") %>%
  ggplot(aes(x = var1, y = var2, fill = cor, label = cor)) + 
  geom_tile(color = "white") +   
  geom_text(color = "white",size = 4) + 
  scale_x_discrete(labels = c("Borough Monthly cases")) + 
  labs(x = "Outcome Variable", y = "Predictor Variables",
       fill = "Correlation")
```


Through the correlation analysis between predictors and outcome, the result above shown that the borough was comparatively related to the outcome.

&nbsp;

&nbsp;


#### Model Selection

##### Full Model
```{r, message = FALSE, warning = FALSE}
# full model
cases_borough_monthly = cases_borough_monthly %>% 
  mutate(inspection_month = month.abb[inspection_month_n],
         covid_yn = as.factor(covid_yn))


model_linear_full = lm(borough_monthly_cases ~ inspection_month + borough + covid_yn + avg_prcp + avg_snow + avg_snwd + avg_temp, data = cases_borough_monthly) 

broom::tidy(model_linear_full) %>% 
   knitr::kable()

#summary(model_linear_full)
```

The full multiple linear regression model we constructed is 

$borough\_monthly\_cases= \beta_0+ \beta_1(inspectionMonth) + \beta_2(borough) + \beta_3(covid) + \beta_4(avg\_precipitaiton) + \\\beta_5(avg\_snowFall) + \beta_6(avg\_snowDepth) + \beta_7(avg\_temperature)$.   

The result shown that the p-value of `inspectionMonth`, `avg_precipitaiton`, `avg_snowFall`, and `avg_temperature` were greater than 0.05, which had to be analyzed by stepwise regression method.

&nbsp;

&nbsp;

##### Stepwise Selection in Full Model

```{r, message = FALSE, warning = FALSE}
# stepwise with AIC (full model)
model_linear = step(model_linear_full, direction = "both")

#model_linear = lm(borough_monthly_cases ~ borough + covid_yn + avg_snow + avg_snwd, data = cases_borough_monthly) 

 
 broom::tidy(model_linear) %>% 
   knitr::kable()

#summary(model_linear)
```


We eliminated those variables that are not statistically significant using stepwise regression: 
$borough\_monthly\_cases= \beta_0+ \beta_1(borough) + \beta_2(covid) + \beta_3(snowFall) + \beta_4(snowDepth)$

&nbsp;

&nbsp;

##### Full Model with Log Transformation

```{r, message = FALSE, warning = FALSE}
# full model with log transformation
model_linear_full_log = lm(log(borough_monthly_cases) ~ inspection_month + borough + covid_yn + avg_prcp + avg_snow + avg_snwd + avg_temp, data = cases_borough_monthly) 

 broom::tidy(model_linear_full_log) %>% 
   knitr::kable()

#summary(model_linear_full_log)
```

Log transformation was applied to our model to improve validity, additivity, and linearity:
$log(borough\_monthly\_cases)= \beta_0+ \beta_1(inspectionMonth) + \beta_2(borough) + \beta_3(covid) + \beta_4(avg\_precipitaiton) + \\\beta_5(avg\_snowFall) + \beta_6(avg\_snowDepth) + \beta_7(avg\_temperature)$

&nbsp;

&nbsp;

##### Stepwise Selection in Full Model with Log Transformation

```{r, message = FALSE, warning = FALSE}
# stepwise with AIC
model_linear_log = step(model_linear_full_log, direction = "both")

#model_linear_log = lm(log(borough_monthly_cases) ~ inspection_month + borough + covid_yn + avg_prcp + avg_snwd + avg_temp, data = cases_borough_monthly) 


 broom::tidy(model_linear_log) %>% 
   knitr::kable()


#summary(model_linear_log)
```

Same as the original linear model above, we also applied the stepwise selection and got the final model:
$log(borough\_monthly\_cases)= \beta_0+ \beta_1(inspectionMonth) + \beta_2(borough) + \beta_3(covid) + \beta_4(avg\_precipitaiton)+ \\\beta_5(avg\_snowDepth) + \beta_6(avg\_temperature)$

&nbsp;

&nbsp;

#### Model Diagnostics

```{r, message = FALSE, warning = FALSE, fig.width = 12,  fig.height = 9}
performance::check_model(model_linear, check = c("linearity", "qq", "normality", "outliers", "homogeneity", "vif"))
```


```{r, message = FALSE, warning = FALSE, fig.width = 12, fig.height = 9}

performance::check_model(model_linear_log, check = c("linearity", "qq", "normality", "outliers", "homogeneity", "vif"))

```

According to plots above, we can see that linearity, homogeneity, and normality of residuals were all improved after the log transformation. Residuals were distributed around the 0 horizontal line and the reference line was flatter. There was no influential points outside the contour lines. Also, the residuals were approximately normally distributed.

&nbsp;

&nbsp;


#### Cross-validation


```{r, message=FALSE, warning=FALSE, fig.height = 6}
# cross-validation 
set.seed(2022)

# without log
cv_df_1 = 
  crossv_mc(cases_borough_monthly, 100) %>% 
    mutate(
        train = map(train, as_tibble),
        test = map(test,as_tibble)
    )  %>%
  mutate(
    model_fit1  = map(train, ~lm(borough_monthly_cases ~ inspection_month + borough + covid_yn + avg_prcp + avg_snow + avg_snwd + avg_temp, data = .x)),
    model_fit2  = map(train, ~lm(borough_monthly_cases ~ borough + covid_yn + avg_snow + avg_snwd, data = .x))) %>% 
  mutate(
    rmse_1 = map2_dbl(model_fit1, test, ~rmse(model = .x, data = .y)),
    rmse_2 = map2_dbl(model_fit2, test, ~rmse(model = .x, data = .y))) 

p_cv_1 = cv_df_1 %>% 
  select(starts_with("rmse")) %>% 
  pivot_longer(
    everything(),
    names_to = "model", 
    values_to = "rmse",
    names_prefix = "rmse_") %>% 
  mutate(model = fct_inorder(model)) %>% 
  ggplot(aes(x = model, y = rmse)) + 
  geom_violin() +
  labs(title = "Comparison of the Cross-Validated Prediction Error", 
       x = "Models", 
       y = "Root Mean Square Error (RMSE)")  +
  scale_x_discrete(labels = c("Full Model", "Stepwise Model")) 

# log
cv_df_2 = 
  crossv_mc(cases_borough_monthly, 100) %>% 
    mutate(
        train = map(train, as_tibble),
        test = map(test,as_tibble)
    )  %>%
  mutate(
    model_fit3  = map(train, ~lm(log(borough_monthly_cases) ~ inspection_month + borough + covid_yn + avg_prcp + avg_snow + avg_snwd + avg_temp, data = .x)),
    model_fit4  = map(train, ~lm(log(borough_monthly_cases) ~ inspection_month + borough + covid_yn + avg_prcp + avg_snwd + avg_temp, data = .x))) %>% 
  mutate(
    rmse_3 = map2_dbl(model_fit3, test, ~rmse(model = .x, data = .y)),
    rmse_4 = map2_dbl(model_fit4, test, ~rmse(model = .x, data = .y))) 

p_cv_2 = cv_df_2 %>% 
  select(starts_with("rmse")) %>% 
  pivot_longer(
    everything(),
    names_to = "model", 
    values_to = "rmse",
    names_prefix = "rmse_") %>% 
  mutate(model = fct_inorder(model)) %>% 
  ggplot(aes(x = model, y = rmse)) + 
  geom_violin() +
  labs(title = "Comparison of the Cross-Validated Prediction Error", 
       x = "Models", 
       y = "Root Mean Square Error (RMSE)")  +
  scale_x_discrete(labels = c("Full Model (Log)", "Stepwise Model (Log)")) 


p_cv_1 / p_cv_2


```

According to the plot, there was a significant difference on RMSE between models with and without log-transformed outcomes. Model with log-transformation had a substantially lower average value of RMSE, which means this type of model better fits. After stepwise selection, only one variable was dropped and the RMSE were similar. We preferred the model with less variables to avoid potential over-fit.

&nbsp;

&nbsp;



## Discussion

### Main Findings

In our exploratory analysis, we explored the patterns and characteristics of rat inspections through visualizations in both spatial and temporal dimensions and analyzed the association between inspections and some interesting covariates. 

When looking at the number of rat inspections in different time levels, we first found out that from 2012 to 2019, the count generally presented a continual increasing trend while it appeared a sharp decrease as the outbreak of COVID-19 in 2020. The distribution failed to show a obvious pattern that rats preferred which month but reminded us that a nicer weather in spring might be comfortable for their urban-life. To be more specific, rat inspections concentrated at daytime due to people's working schedule and clear vision. 

From the visualization by borough, it's undoubtful that Brooklyn and Manhattan were two rattiest boroughs, one was the first in the number of rat inspections, and the other was the first in the density. We also listed top 5 rat popular streets in each borough to help those feel scared of rats avoid them. But unfortunately, some of them are main roads such as Broadway. Moreover, more rat inspections happened when temperatures were between 20 and 30 degrees Celsius but this pattern was not significant.

The results of hypothesis test further verified our sights gained from EDA. Rat inspections among boroughs have a significantly different distribution across years. After transforming the numeric temperature to the categorical feeling variable (cold, warm, etc.), we found that the inspections are not equally distributed in different weather in 2021. Not suprisingly, the count difference before and after COVID-19 was proved significant by Wilcoxon Rank-sum test, which was consistent with EDA result.

In our linear regression model, we considered that the monthly rat inspection count was a linear combination of 6 predictors. We found precipitation and average monthly temperature had a slightly positive association with our outcome while snow depth and the outbreak of COVID-19 would be negatively associated. Besides, inspection month and borough are two important categorical predictors in our final model.

&nbsp;

&nbsp;


### Limitations

It is estimated that 2 million rats living in New York City but no one knows exactly how many rats live here. Considering the attributes of animals and rats' flexible body, high speed of scurry and wide range of activity, it is very hard to conduct rat population census just like human beings. Therefore, we used the number of rat inspections to represent. Chances are that none of the rats were inspected during one inspection or one rat was repeatedly inspected during multiple inspections, which could introduce some biases.

The weakness of multiple linear regression cannot be ignored. For instance, it will not be good at explaining the relationship of the independent variable temperature to the dependent rat inspection count since their relationship are not strictly linear. Rat prefer 30-32 degrees Celsius, but it does not represent higher the temperature, more active are the rats.

&nbsp;

&nbsp;


### Next Steps

Based on our comprehensive analysis, future research could focus on how to better predict the number of rat population and the rate of observing the rat given a specific condition of time, location, weather, etc. Meanwhile, we will actively seek more informative data to explore other potential covariates. We believe that it will be beneficial not only individually, but also in a broad sense, to identify potential public health issues and help build a pleasant living environment.







