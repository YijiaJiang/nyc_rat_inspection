---
title: "Exploratory Data Analysis"
output: 
  html_document:
    toc: true
    toc_float: 
      toc_collapsed: true
    toc_depth: 5
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
library(tidyverse)
library(plotly)
library(highcharter)
library(xts)
library(rgdal)
library(leaflet)
library(leaflet.extras)
library(patchwork)

theme_set(theme_minimal() + theme(legend.position = "bottom"))
```

```{r, message=FALSE, include=FALSE}
url_2012 = "https://raw.githubusercontent.com/YijiaJiang/p8105_final_project_data/main/rat_2012.csv"
rat_2012 = read_csv(url_2012)

url_2013 = "https://raw.githubusercontent.com/YijiaJiang/p8105_final_project_data/main/rat_2013.csv"
rat_2013 = read_csv(url_2013)

url_2014 = "https://raw.githubusercontent.com/YijiaJiang/p8105_final_project_data/main/rat_2014.csv"
rat_2014 = read_csv(url_2014)

url_2015 = "https://raw.githubusercontent.com/YijiaJiang/p8105_final_project_data/main/rat_2015.csv"
rat_2015 = read_csv(url_2015)

url_2016 = "https://raw.githubusercontent.com/YijiaJiang/p8105_final_project_data/main/rat_2016.csv"
rat_2016 = read_csv(url_2016) 

url_2017 = "https://raw.githubusercontent.com/YijiaJiang/p8105_final_project_data/main/rat_2017.csv"
rat_2017 = read_csv(url_2017)

url_2018 = "https://raw.githubusercontent.com/YijiaJiang/p8105_final_project_data/main/rat_2018.csv"
rat_2018 = read_csv(url_2018)

url_2019 = "https://raw.githubusercontent.com/YijiaJiang/p8105_final_project_data/main/rat_2019.csv"
rat_2019 = read_csv(url_2019) 

url_2020 = "https://raw.githubusercontent.com/YijiaJiang/p8105_final_project_data/main/rat_2020.csv"
rat_2020 = read_csv(url_2020)

url_2021 = "https://raw.githubusercontent.com/YijiaJiang/p8105_final_project_data/main/rat_2021.csv"
rat_2021 = read_csv(url_2021)

url_covid = "https://raw.githubusercontent.com/YijiaJiang/p8105_final_project_data/main/rat_weather_covid.csv"
rat_covid = read_csv(url_covid)

rat = bind_rows(rat_2012, rat_2013, rat_2014, rat_2015, rat_2016, rat_2017, rat_2018, rat_2019, rat_2020, rat_2021) %>%
  select(-...1) %>%
   mutate(inspection_month_n = recode(inspection_month, 
                                   "Jan" = 1,
                                   "Feb" = 2,
                                   "Mar" = 3,
                                   "Apr" = 4,
                                   "May" = 5,
                                   "Jun" = 6,
                                   "Jul" = 7,
                                   "Aug" = 8,
                                   "Sep" = 9,
                                   "Oct" = 10,
                                   "Nov" = 11,
                                   "Dec" = 12)) %>%
  mutate(date = paste(inspection_year, inspection_month_n, inspection_day, sep = "-"))%>%
  mutate(date = as.Date(date,format = "%Y-%m-%d"))

rat_covid = rat_covid %>%
  mutate(inspection_month_n = recode(inspection_month, 
                                   "Jan" = 1,
                                   "Feb" = 2,
                                   "Mar" = 3,
                                   "Apr" = 4,
                                   "May" = 5,
                                   "Jun" = 6,
                                   "Jul" = 7,
                                   "Aug" = 8,
                                   "Sep" = 9,
                                   "Oct" = 10,
                                   "Nov" = 11,
                                   "Dec" = 12)) %>%
  mutate(date = paste(inspection_year, inspection_month_n, inspection_day, sep = "-"))%>%
  mutate(date = as.Date(date,format = "%Y-%m-%d"))

```

# Time Visualizations

In order to obtain in-depth sights of the rat inspections across time, we used four different levels to analyze. 

### Overall Rat Inspections Across Time 

First, a time series plot was used to illustrate data points at successive intervals of time. From 2012, the number of rat inspections continually presented a increasing trend and reached its peak in 2018. After 2020, it appeared a sharp decrease as the outbreak of COVID-19.

```{r, message=FALSE, warning=FALSE}
by_date = rat %>% 
  group_by(date) %>% 
  summarise(Total = n())

time_series = xts(by_date$Total , order.by= by_date$date)

hchart(time_series, name = "Rat Inspections") %>% 
  hc_credits(enabled = TRUE, text = "Sources: NYC OpenData", style = list(fontSize = "12px")) %>%
  hc_title(text = "Time Series of NYC Rat Inspections") %>%
  hc_legend(enabled = TRUE)
```

### Rat Inspections by Year

To be more specific, we compared the rat inspections year by year. The number was roughly around 150,000 in 2012-2016. There was a surge of rat inspections in 2017 which had 247,985 cases. After staying at the peak in 2018-2019, the number of inspections rapidly dropped to 71,770 in 2020. Whether this drop was associated with COVID-19 will be analyzed in the following section.

```{r, message=FALSE, warning=FALSE}
rat %>%
  mutate(inspection_year = as.factor(inspection_year)) %>%
  group_by(inspection_year) %>%
  summarise(n_obs = n()) %>%
  plot_ly(x = ~inspection_year, y = ~n_obs, type = "scatter", mode = "lines+markers") %>%
  layout(xaxis = list(title = "Year"), 
         yaxis = list(title = "Count"),
         title = "Number of Rat Inspections by Year") 
```

### Rat Inspections by Month

The average number of rat inspections was 13,997. We plotted the number of inspections every months across years and found that rats were more likely to be inspected in spring compared to winter. This might be due to the nicer weather in spring, suitable for rats to wander outside.

```{r, message=FALSE, warning=FALSE}
rat %>%
  mutate(inspection_month = as.factor(inspection_month)) %>%
  mutate(inspection_month = inspection_month %>% 
                       fct_relevel("Jan", "Feb", "Mar","Apr","May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")) %>%
  group_by(inspection_year, inspection_month) %>%
  summarise(n_obs = n()) %>%
  plot_ly(x = ~inspection_month, y = ~n_obs, type = "box",
          color = ~inspection_month) %>%
  layout(xaxis = list(title = "Month"), 
         yaxis = list(title = "Count"),
         title = "Number of Rat Inspections by Month") %>%
  hide_legend()
```

### Rat Inspections Througout a Day

Most rat inspections happened at daytime regardless of the month, concentrated at 9am-12pm. Contradicted with the common sense that rats prefer nightlife, this finding would be corresponding to inspectors' daily schedule. Additionally, there are a few explanations for rat sightings during daylight hours:  

*  The infestation is large  
*  The older/sub-dominant rats cannot compete with dominant rats for food during the safer night time period

```{r, message=FALSE, warning=FALSE}
rat_2021 %>%
  mutate(inspection_day = as.factor(inspection_day)) %>%
  mutate(inspection_month = as.factor(inspection_month)) %>%
  mutate(inspection_month = inspection_month %>% 
                       fct_relevel("Jan", "Feb", "Mar","Apr","May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")) %>%
  separate(inspection_time, into = c("hour", "minute", "second")) %>%
  rename(Month = inspection_month) %>%
  group_by(Month, inspection_day, hour) %>%
  summarise(n_obs = n()) %>%
  plot_ly(x = ~hour, y = ~n_obs, type = "scatter",
          color = ~inspection_day,
          frame = ~Month) %>%
  layout(xaxis = list(title = "Time", range = list(0,24), dtick = 3, 
                      tickvals = c(0, 3, 6, 9, 12, 15, 18, 21, 24),
                      ticktext = c("12am", "3am", "6am", "9am", "12pm", "3pm", "6pm", "9pm", "12am")),
         yaxis = list(title = "Count"),
         title = "Number of Rat Inspections Throughout a Day in 2021") %>%
  hide_legend()

```

&nbsp;

# Borough Visualizations

In this section, we will explore the demographic characteristics of the rat inspections to find whether there exists some potential spatial patterns or not. 

### Overall Rat Inspections by Borough

First, letâ€™s look at the overall rat inspections in each borough across years. Brooklyn, Bronx and Manhattan always ranked top 3 most rat inspections while Queens and Staten Island had quite fewer inspections. 

```{r, message=FALSE, warning=FALSE}
# Overall
rat %>%
 mutate(borough = as.factor(borough)) %>%
  rename(Year = inspection_year) %>%
  group_by(Year, borough) %>%
  summarise(n_obs = n()) %>%
  plot_ly(x = ~borough, y = ~n_obs, color = ~borough, frame = ~Year, type = "bar") %>%
  layout(xaxis = list(title = "Borough"), 
         yaxis = list(title = "Count"),
         title = "Number of Rat Inspections by Borough") %>%
  hide_legend()
```

### Rat Inspections VS. Population

```{r, message=FALSE, warning=FALSE}
# rat vs. population
p_rat = rat %>%
  filter(inspection_year == 2021) %>%
  mutate(borough = as.factor(borough)) %>%
  group_by(borough) %>%
  summarise(rat_obs = n()) %>%
  ggplot(aes(x = rat_obs, y = borough, fill = borough)) +
  geom_col(show.legend = FALSE) +
  scale_fill_manual(values = c("#38C5A3", "#F09968", "#8DA0CB", "#EE90BA", "#A8D14F")) +
  labs(x = "Count",
       y = "Borough",
      titles = "Number of Rat Inspections in 2021") +
  theme(plot.title = element_text(size = 12)) 

p_pop = rat %>%
  filter(inspection_year == 2021) %>%
  mutate(borough = as.factor(borough)) %>%
  group_by(borough) %>%
  summarise(rat_obs = n()) %>%
  mutate(pop = c(1424948, 2641052, 1576876, 2331143, 493494)) %>%
  ggplot(aes(x = pop, y = borough, fill = borough)) +
  geom_col(show.legend = FALSE) +
  scale_fill_manual(values = c("#38C5A3", "#F09968", "#8DA0CB", "#EE90BA", "#A8D14F")) +
  labs(x = "Count",
       y = "Borough",
       titles = "Number of Populations in 2021") +
  theme(plot.title = element_text(size = 12))

p_rat + p_pop 
```

### Rat Inspections by Month in Each Borough {.tabset}

#### Bronx
```{r, message=FALSE, warning=FALSE}
avg_2021 = rat %>%
  filter(inspection_year == 2021) %>%
  mutate(inspection_month = as.factor(inspection_month)) %>%
  mutate(inspection_month = inspection_month %>% 
                       fct_relevel("Jan", "Feb", "Mar","Apr","May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")) %>%
  group_by(inspection_year, inspection_month) %>%
  summarise(n_avg = n()/5)

rat %>%
  filter(borough == "Bronx") %>%
  filter(inspection_year == 2021) %>%
  mutate(inspection_month = as.factor(inspection_month)) %>%
  mutate(inspection_month = inspection_month %>% 
                       fct_relevel("Jan", "Feb", "Mar","Apr","May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")) %>%
  group_by(inspection_year, inspection_month) %>%
  summarise(n_obs = n()) %>%
  mutate(avg_2021_n = c(822.2, 534.8, 1178.0, 1575.2, 2053.2, 2420.8, 3132.2, 3677.6, 1136.0, 701.4, 1969.0, 1925.4)) %>%
  plot_ly(x = ~inspection_month, y = ~n_obs, type = "bar",
          color = "#8DA0CB", alpha = 0.7,
          name = "Bronx") %>%
  add_trace(x = ~inspection_month, 
            y = ~avg_2021_n, 
            type = "scatter", mode = "lines+markers",
            color = "#F09968",
            name = "Borough Average") %>%
  layout(xaxis = list(title = "Month"), 
         yaxis = list(title = "Count"),
         title = "Number of Rat Inspections in Bronx in 2021") 
```

#### Brooklyn
```{r, message=FALSE, warning=FALSE}
rat %>%
  filter(borough == "Brooklyn") %>%
  filter(inspection_year == 2021) %>%
  mutate(inspection_month = as.factor(inspection_month)) %>%
  mutate(inspection_month = inspection_month %>% 
                       fct_relevel("Jan", "Feb", "Mar","Apr","May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")) %>%
  group_by(inspection_year, inspection_month) %>%
  summarise(n_obs = n()) %>%
  mutate(avg_2021_n = c(822.2, 534.8, 1178.0, 1575.2, 2053.2, 2420.8, 3132.2, 3677.6, 1136.0, 701.4, 1969.0, 1925.4)) %>%
  plot_ly(x = ~inspection_month, y = ~n_obs, type = "bar",
          color = "#8DA0CB", alpha = 0.7,
          name = "Brooklyn") %>%
  add_trace(x = ~inspection_month, 
            y = ~avg_2021_n, 
            type = "scatter", mode = "lines+markers",
            color = "#F09968",
            name = "Borough Average") %>%
  layout(xaxis = list(title = "Month"), 
         yaxis = list(title = "Count"),
         title = "Number of Rat Inspections in Brooklyn in 2021") 
```

#### Manhattan
```{r, message=FALSE, warning=FALSE}
rat %>%
  filter(borough == "Manhattan") %>%
  filter(inspection_year == 2021) %>%
  mutate(inspection_month = as.factor(inspection_month)) %>%
  mutate(inspection_month = inspection_month %>% 
                       fct_relevel("Jan", "Feb", "Mar","Apr","May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")) %>%
  group_by(inspection_year, inspection_month) %>%
  summarise(n_obs = n()) %>%
  mutate(avg_2021_n = c(822.2, 534.8, 1178.0, 1575.2, 2053.2, 2420.8, 3132.2, 3677.6, 1136.0, 701.4, 1969.0, 1925.4)) %>%
  plot_ly(x = ~inspection_month, y = ~n_obs, type = "bar",
          color = "#8DA0CB", alpha = 0.7,
          name = "Manhattan") %>%
  add_trace(x = ~inspection_month, 
            y = ~avg_2021_n, 
            type = "scatter", mode = "lines+markers",
            color = "#F09968",
            name = "Borough Average") %>%
  layout(xaxis = list(title = "Month"), 
         yaxis = list(title = "Count"),
         title = "Number of Rat Inspections in Manhattan in 2021") 
```

#### Queens
```{r, message=FALSE, warning=FALSE}
rat %>%
  filter(borough == "Queens") %>%
  filter(inspection_year == 2021) %>%
  mutate(inspection_month = as.factor(inspection_month)) %>%
  mutate(inspection_month = inspection_month %>% 
                       fct_relevel("Jan", "Feb", "Mar","Apr","May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")) %>%
  group_by(inspection_year, inspection_month) %>%
  summarise(n_obs = n()) %>%
  mutate(avg_2021_n = c(822.2, 534.8, 1178.0, 1575.2, 2053.2, 2420.8, 3132.2, 3677.6, 1136.0, 701.4, 1969.0, 1925.4)) %>%
  plot_ly(x = ~inspection_month, y = ~n_obs, type = "bar",
          color = "#8DA0CB", alpha = 0.7,
          name = "Queens") %>%
  add_trace(x = ~inspection_month, 
            y = ~avg_2021_n, 
            type = "scatter", mode = "lines+markers",
            color = "#F09968",
            name = "Borough Average") %>%
  layout(xaxis = list(title = "Month"), 
         yaxis = list(title = "Count"),
         title = "Number of Rat Inspections in Queens in 2021") %>%
  hide_legend()
```

#### Staten Island
```{r, message=FALSE, warning=FALSE}
rat %>%
  filter(borough == "Staten Island") %>%
  filter(inspection_year == 2021) %>%
  mutate(inspection_month = as.factor(inspection_month)) %>%
  mutate(inspection_month = inspection_month %>% 
                       fct_relevel("Jan", "Feb", "Mar","Apr","May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")) %>%
  group_by(inspection_year, inspection_month) %>%
  summarise(n_obs = n()) %>%
  mutate(avg_2021_n = c(822.2, 534.8, 1178.0, 1575.2, 2053.2, 2420.8, 3132.2, 3677.6, 1136.0, 701.4, 1969.0, 1925.4)) %>%
  plot_ly(x = ~inspection_month, y = ~n_obs, type = "bar",
          color = "#8DA0CB", alpha = 0.7,
          name = "Staten Island") %>%
  add_trace(x = ~inspection_month, 
            y = ~avg_2021_n, 
            type = "scatter", mode = "lines+markers",
            color = "#F09968",
            name = "Borough Average") %>%
  layout(xaxis = list(title = "Month"), 
         yaxis = list(title = "Count"),
         title = "Number of Rat Inspections in Staten Island in 2021") 
```


```{r, message=FALSE, warning=FALSE}
# Overall top 15 streets
rat %>%
  filter(inspection_year == 2021) %>%
  mutate(street_name = str_to_title(street_name)) %>%
  group_by(street_name) %>%
  summarise(rat_obs = n()) %>%
  arrange(-rat_obs) %>% 
  top_n(20) %>%
  mutate(street_name = fct_reorder(street_name, rat_obs)) %>%
  plot_ly(x = ~rat_obs, y = ~street_name, color = ~street_name, type = "bar") %>%
  layout(xaxis = list(title = "Count"), 
         yaxis = list(title = "Street"),
         title = "Top 15 Rat Popular Streets in 2021") %>%
  hide_legend()
```

### Top 5 Rat Popular Street{.tabset}

#### Bronx
```{r, message=FALSE, warning=FALSE}
rat %>%
  filter(inspection_year == 2021) %>%
  filter(borough == "Bronx") %>%
  mutate(street_name = str_to_title(street_name)) %>%
  group_by(street_name) %>%
  summarise(rat_obs = n()) %>%
  arrange(-rat_obs) %>% 
  top_n(5) %>%
  mutate(street_name = fct_reorder(street_name, rat_obs)) %>%
  plot_ly(x = ~rat_obs, y = ~street_name, color = ~street_name, type = "bar") %>%
  layout(xaxis = list(title = "Count"), 
         yaxis = list(title = "Street"),
         title = "Top 5 Rat Popular Streets in Bronx in 2021") %>%
  hide_legend()
```

#### Brooklyn
```{r, message=FALSE, warning=FALSE}
rat %>%
  filter(inspection_year == 2021) %>%
  filter(borough == "Brooklyn") %>%
  mutate(street_name = str_to_title(street_name)) %>%
  group_by(street_name) %>%
  summarise(rat_obs = n()) %>%
  arrange(-rat_obs) %>% 
  top_n(5) %>%
  mutate(street_name = fct_reorder(street_name, rat_obs)) %>%
  plot_ly(x = ~rat_obs, y = ~street_name, color = ~street_name, type = "bar") %>%
  layout(xaxis = list(title = "Count"), 
         yaxis = list(title = "Street"),
         title = "Top 5 Rat Popular Streets in Brooklyn in 2021") %>%
  hide_legend()
```

#### Manhattan
```{r, message=FALSE, warning=FALSE}
rat %>%
  filter(inspection_year == 2021) %>%
  filter(borough == "Manhattan") %>%
  mutate(street_name = str_to_title(street_name)) %>%
  group_by(street_name) %>%
  summarise(rat_obs = n()) %>%
  arrange(-rat_obs) %>% 
  top_n(5) %>%
  mutate(street_name = fct_reorder(street_name, rat_obs)) %>%
  plot_ly(x = ~rat_obs, y = ~street_name, color = ~street_name, type = "bar") %>%
  layout(xaxis = list(title = "Count"), 
         yaxis = list(title = "Street"),
         title = "Top 5 Rat Popular Streets in Manhattan in 2021") %>%
  hide_legend()
```

#### Queens
```{r, message=FALSE, warning=FALSE}
rat %>%
  filter(inspection_year == 2021) %>%
  filter(borough == "Queens") %>%
  mutate(street_name = str_to_title(street_name)) %>%
  group_by(street_name) %>%
  summarise(rat_obs = n()) %>%
  arrange(-rat_obs) %>% 
  top_n(5) %>%
  mutate(street_name = fct_reorder(street_name, rat_obs)) %>%
  plot_ly(x = ~rat_obs, y = ~street_name, color = ~street_name, type = "bar") %>%
  layout(xaxis = list(title = "Count"), 
         yaxis = list(title = "Street"),
         title = "Top 5 Rat Popular Streets in Queens in 2021") %>%
  hide_legend()
```

#### Staten Island
```{r, message=FALSE, warning=FALSE}
rat %>%
  filter(inspection_year == 2021) %>%
  filter(borough == "Staten Island") %>%
  mutate(street_name = str_to_title(street_name)) %>%
  group_by(street_name) %>%
  summarise(rat_obs = n()) %>%
  arrange(-rat_obs) %>% 
  top_n(5) %>%
  mutate(street_name = fct_reorder(street_name, rat_obs)) %>%
  plot_ly(x = ~rat_obs, y = ~street_name, color = ~street_name, type = "bar") %>%
  layout(xaxis = list(title = "Count"), 
         yaxis = list(title = "Street"),
         title = "Top 5 Rat Popular Streets in Staten Island in 2021") %>%
  hide_legend()
```

```{r, message=FALSE, warning=FALSE}
# inspection type
colors = c("#38C5A3", "#F09968", "#D2959B", "#B499CB", "#EE90BA", "#A8D14F", "#E5D800", "#FCCD4C", "#E2BF96", "#B3B3B3")

rat %>%
  mutate(inspection_type = case_when(inspection_type == "Initial" ~ "Initial Inspection",
                                     inspection_type == "BAIT" ~ "Baiting", 
                                     inspection_type == "Compliance"~ "Compliance Inspection", 
                                     inspection_type == "STOPPAGE" ~ "Stoppage", 
                                     inspection_type == "CLEAN_UPS" ~ "Clean Up")) %>%
  group_by(inspection_type) %>%
  summarise(n_obs = n(),
            prop = n_obs/nrow(rat)) %>%
  arrange(-prop) %>% 
  mutate(inspection_type = fct_reorder(inspection_type, -prop)) %>%
  plot_ly(labels = ~inspection_type, values = ~prop, type = "pie",
          insidetextfont = list(color = "#FFFFFF"),
          marker = list(colors = colors,
                      line = list(color = '#FFFFFF', width = 1))
          ) %>%
  layout(title = "Distribution of Inspection Type",
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))


```


```{r, message=FALSE, warning=FALSE}
# inspection results
colors = c("#38C5A3", "#F09968", "#D2959B", "#B499CB", "#EE90BA", "#A8D14F", "#E5D800", "#FCCD4C", "#E2BF96", "#B3B3B3")

rat %>%
  drop_na() %>%
  group_by(result) %>%
  summarise(n_obs = n(),
            prop = n_obs/nrow(rat)) %>%
  arrange(-prop) %>% 
  mutate(result = fct_reorder(result, -prop)) %>%
  plot_ly(labels = ~result, values = ~prop, type = "pie",
          insidetextfont = list(color = "#FFFFFF"),
          marker = list(colors = colors,
                      line = list(color = '#FFFFFF', width = 1))
          ) %>%
  layout(title = "Distribution of Inspection Results",
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

```

# Weather and COVID-19

```{r, message=FALSE, warning=FALSE}
# association with temperature
rat_n = rat %>%
  group_by(inspection_year, inspection_month, inspection_day) %>%
  summarise(Count = n())

t = rat %>%
  mutate(`Average Temperature` = (tmin+tmax)/2) %>%
  rename(Date = date) %>%
  distinct(inspection_year, inspection_month, inspection_day, `Average Temperature`, tmax, tmin, Date)

rat_t = left_join(rat_n, t, by = c("inspection_year", "inspection_month", "inspection_day")) %>%
  as.data.frame()

p_weather = rat_t %>% 
  filter(inspection_year == 2021) %>%
  ggplot(aes(x = Date, y = `Average Temperature`)) + 
  geom_point(aes(size = Count), alpha = .5, color = "#66C2A5") +
  geom_smooth(se = FALSE, color = "#8DA0CB") +
  labs(x = "Month",
       y = "Average Temperature",
       title = "Assocition Between Number of Rat Inspections and Temperature")

ggplotly(p_weather)

```

```{r, message=FALSE, warning=FALSE}
# changes before and after Covid-19
rat %>%
  filter(inspection_year %in% c(2019, 2020)) %>%
  mutate(inspection_year = as.factor(inspection_year)) %>%
  mutate(inspection_month = as.factor(inspection_month)) %>%
  mutate(inspection_month = inspection_month %>% 
                       fct_relevel("Jan", "Feb", "Mar","Apr","May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")) %>%
  group_by(inspection_year, inspection_month) %>%
  summarise(n_obs = n()) %>%
  plot_ly(x = ~inspection_month, y = ~n_obs, type = "scatter", mode = "lines",
          color = ~inspection_year) %>%
  layout(xaxis = list(title = "Inspection Month"), 
         yaxis = list(title = "Number of Inspections"),
         title = "Number of Rat Inspections Before and After COVID-19") 
```

```{r, message=FALSE, warning=FALSE}
# association with Covid-19
rat_obs = rat %>%
  group_by(date) %>%
  summarise(Count = n()) 

c = rat_covid %>%
  distinct(inspection_year, inspection_month, inspection_day, total_case_count, date)

rat_covid_c = left_join(c, rat_obs, by = "date") %>%
  select(inspection_year, date, Count, total_case_count) %>%
  as.data.frame()
  
rat_covid_c %>% 
  ggplot(aes(x=Count, y = total_case_count)) +
  geom_point()
  
rat_covid_c %>% 
  filter(total_case_count<=2000) %>%
  ggplot(aes(x = date)) + 
  geom_smooth(aes(y = total_case_count), color = "#66C2A5", se = FALSE) +
  geom_smooth(aes(y = Count), color = "#8DA0CB", se = FALSE) +
  labs(x = "Month",
       y = "Number of Cases",
       title = "Assocition Between Number of Rat Inspections and COVID-19")

p_covid = rat_covid_c %>% 
  ggplot(aes(x = Count, y = total_case_count)) +
  geom_point(color = "#66C2A5", alpha = 0.5) +
  geom_smooth(se=FALSE, color = "#8DA0CB") 
  

ggplotly(p_covid)

```






